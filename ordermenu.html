<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
<style>
  :root{
    --orange:#FFA500; --orange-2:#FFB84D; --blue:#0047AB; --blue-2:#0066CC;
    --white:#FFFFFF; --glass:rgba(255,255,255,0.9);
    --card-bg: #fff7ef;
  }
  *{box-sizing:border-box}
  body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,var(--orange) 0%,#fff 60%,var(--blue));color:#002366;margin:0;padding:0;-webkit-font-smoothing:antialiased}
  header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:transparent;gap:10px}
  .btn-nav{padding:8px 14px;border:none;border-radius:10px;background:var(--glass);color:#002366;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.06);transition:transform .15s}
  .btn-nav:hover{transform:translateY(-2px)}
  h1{text-align:center;margin:8px 0 12px;font-size:1.6rem;color:#002366}
  .container{display:flex;gap:12px;padding:12px;align-items:flex-start;max-width:1180px;margin:0 auto}
  .order-summary{width:320px;background:var(--card-bg);border-radius:16px;padding:14px;margin-right:8px;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.08);border:1px solid rgba(0,0,0,0.04)}
  .order-summary h3{margin:0 0 8px}
  .order-item{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:6px 0;background:white;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.04)}
  .order-summary .total{margin-top:10px;text-align:center;font-weight:800;font-size:1.15rem}
  .order-summary button{display:block;width:100%;margin-top:8px;padding:10px;border:none;border-radius:10px;font-weight:700;cursor:pointer}
  .btn-add{background:linear-gradient(90deg,var(--orange),var(--orange-2));color:#002366}
  .btn-cash{background:linear-gradient(90deg,#4CAF50,#45A049);color:#fff}
  .btn-qr{background:linear-gradient(90deg,#0066CC,#0047AB);color:#fff}
  .btn-cancel{background:linear-gradient(90deg,#f44336,#d32f2f);color:white}

  .menu-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;align-items:start;padding:6px}
  .menu-item{background:#fff;border-radius:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.08);padding:12px;cursor:pointer;transition:transform .14s;position:relative;overflow:hidden}
  .menu-item:hover{transform:translateY(-6px)}
  .image-placeholder{width:100%;height:150px;background:#fff;border-radius:10px;display:flex;align-items:center;justify-content:center;margin-bottom:10px;overflow:hidden}
  .image-placeholder img{width:100%;height:100%;object-fit:cover}
  .menu-item h3{margin:8px 0 6px;font-size:1.05rem}
  .menu-item p.cat{color:#666;margin:0 0 6px}
  .menu-item strong{color:var(--blue);font-size:1.05rem}

  .cart-button{position:fixed;bottom:22px;right:22px;background:linear-gradient(90deg,#0047AB,#0066CC);color:white;border-radius:50px;padding:12px 18px;font-size:1.05rem;font-weight:700;box-shadow:0 6px 18px rgba(0,0,0,0.28);z-index:1100;cursor:pointer;border:none}
  .cart-button span{background:#FF5722;border-radius:50%;padding:6px 8px;font-size:.95rem;margin-left:8px;color:white;font-weight:800}

  .overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:none;z-index:999}
  .popup{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,0.2);z-index:1000;width:360px;display:none}
  .popup h3{margin:6px 0 12px}
  .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  .keypad button{padding:12px;background:var(--orange);border:none;border-radius:8px;color:white;font-weight:700;cursor:pointer}
  .keypad button.small{padding:8px}
  .receipt-table{width:100%;border-collapse:collapse}
  .receipt-table th,.receipt-table td{padding:6px;border-bottom:1px dashed rgba(0,0,0,0.08);font-size:0.95rem}

  /* responsive */
  @media (max-width: 900px){
    .container{flex-direction:column;padding:10px}
    .order-summary{position:sticky;top:0;width:100%;z-index:1000;margin-bottom:10px;border-radius:0 0 12px 12px}
    .menu-grid{grid-template-columns:repeat(auto-fit,minmax(160px,1fr))}
    .image-placeholder{height:110px}
  }
  /* Receipt print only */
  @media print{
    body *{visibility:hidden}
    #receiptPrintArea, #receiptPrintArea *{visibility:visible}
    #receiptPrintArea{position:fixed;left:0;top:0;width:100%}
  }

</style>
</head>
<body>
  <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>

  <header>
    <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
    <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
  </header>

  <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>

  <div class="container">
    <div class="order-summary" id="orderSummary" style="display:block;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
      <div id="orderItems"></div>
      <div class="total" id="totalSummary">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ø</div>

      <button class="btn-add" onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button class="btn-cash" onclick="playClick(); payCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      <button class="btn-qr" onclick="playClick(); payQR()">üì± QR Code</button>
      <button class="btn-cancel" onclick="playClick(); cancelOrder()">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>

    <div class="menu-grid" id="menuGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</div>
  </div>

  <button class="cart-button" id="cartButton" onclick="showCart()" style="display:none;">
    üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <span id="cartCount">0</span>
  </button>

  <!-- Cash popup -->
  <div class="popup" id="cashPopup">
    <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
    <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount">0</span> ‡∏ø</strong></p>
    <input id="cashInput" type="text" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" readonly style="width:100%;padding:10px;border-radius:8px;border:1px solid #ddd;margin-bottom:10px;text-align:center;font-size:1.1rem" />
    <div class="keypad">
      <button onclick="appendCash('1')">1</button><button onclick="appendCash('2')">2</button><button onclick="appendCash('3')">3</button>
      <button onclick="appendCash('4')">4</button><button onclick="appendCash('5')">5</button><button onclick="appendCash('6')">6</button>
      <button onclick="appendCash('7')">7</button><button onclick="appendCash('8')">8</button><button onclick="appendCash('9')">9</button>
      <button onclick="clearCash()">C</button><button onclick="appendCash('0')">0</button><button onclick="confirmCash()">‚úÖ</button>
    </div>
    <p id="changeDisplay" style="font-weight:700;margin-top:10px;color:#2e7d32"></p>
  </div>

  <!-- QR popup -->
  <div class="popup" id="qrPopup">
    <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <div style="text-align:center;margin-bottom:8px;">
      <img id="qrImage" src="" alt="QR" style="width:180px;height:180px;object-fit:cover;border-radius:8px;display:none" />
      <div id="qrPlaceholder" style="width:180px;height:180px;background:#f0f0f0;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#999">QR</div>
    </div>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount">0</span> ‡∏ø</strong></p>
    <button onclick="confirmQR()" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
  </div>

  <!-- Discount auth popup -->
  <div class="popup" id="authPopup" style="width:320px">
    <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
    <input id="pinInput" type="password" maxlength="6" readonly style="width:90%;padding:10px;border-radius:8px;border:1px solid #ddd;text-align:center;font-size:1.2rem;margin-bottom:10px"/>
    <div class="keypad">
      <button onclick="appendPin('1')">1</button><button onclick="appendPin('2')">2</button><button onclick="appendPin('3')">3</button>
      <button onclick="appendPin('4')">4</button><button onclick="appendPin('5')">5</button><button onclick="appendPin('6')">6</button>
      <button onclick="appendPin('7')">7</button><button onclick="appendPin('8')">8</button><button onclick="appendPin('9')">9</button>
      <button onclick="clearPin()">C</button><button onclick="appendPin('0')">0</button><button onclick="submitPin()">‚úÖ</button>
    </div>
  </div>

  <!-- receipt popup -->
  <div class="popup" id="receiptPopup" style="width:520px;">
    <div id="receiptPrintArea">
      <h3 style="text-align:center;color:var(--blue)">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
      <div id="receiptDetails"></div>
      <table class="receipt-table" id="receiptTable"></table>
      <div style="text-align:right;margin-top:8px;">
        <button onclick="printReceipt()" style="padding:8px 12px;border-radius:8px;border:none;background:#4CAF50;color:white;font-weight:700">üñ® ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
        <button onclick="closeReceipt()" style="padding:8px 12px;border-radius:8px;border:none;background:#777;color:white;font-weight:700;margin-left:6px">‡∏õ‡∏¥‡∏î</button>
      </div>
    </div>
  </div>

<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

  // ====== Supabase config (‡πÉ‡∏ä‡πâ‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏¥‡∏°‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡∏™‡πà‡∏á) ======
  const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso";
  const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

  // ====== settings ======
  const TAX_RATE = 0.07; // 7%
  const DISCOUNT_PIN = "123456"; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
  const DISCOUNT_OPTIONS = [5,10,15,20]; // % allowed

  const menuGrid = document.getElementById("menuGrid");
  window.order = {}; // global order object
  let currentDiscount = 0; // percent
  let discountAuthorized = false;
  let currentPaymentMethod = ""; // "cash" or "qr"

  // Load menu from supabase - only available = true
  async function loadMenu(){
    try{
      menuGrid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...";
      const { data, error } = await supabase
        .from('menu')
        .select('id,name,price,category,image,available')
        .eq('available', true) // only TRUE records
        .order('id', { ascending: true });

      if (error) {
        console.error("Supabase error:", error);
        menuGrid.innerHTML = "<p style='text-align:center;color:red;'>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>";
        return;
      }
      if (!data || data.length === 0) {
        menuGrid.innerHTML = "<p style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>";
        return;
      }

      menuGrid.innerHTML = data.map(item => {
        // only show image tag if item.image exists (prevent wrong placeholder)
        const imgHtml = item.image ? `<div class="image-placeholder"><img src="${escapeHtml(item.image)}" alt="${escapeHtml(item.name)}" onerror="this.style.display='none'"></div>` : '';
        return `
          <div class="menu-item" onclick="window.addToCart('${item.id}', ${JSON.stringify(item.name)}, ${Number(item.price)})">
            ${imgHtml}
            <h3>${escapeHtml(item.name)}</h3>
            <p class="cat">${escapeHtml(item.category || '')}</p>
            <strong>${item.price} ‡∏ø</strong>
          </div>
        `;
      }).join('');
    }catch(e){
      console.error("loadMenu error", e);
      menuGrid.innerHTML = "<p style='text-align:center;color:red;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>";
    }
  }

  // escape helper
  function escapeHtml(s){
    if (s === null || s === undefined) return '';
    return String(s).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
  }

  // Cart functions
  window.addToCart = (id, name, price) => {
    playClick();
    if (!window.order[id]) window.order[id] = { id, name, price: Number(price), quantity: 0 };
    window.order[id].quantity++;
    updateCart();
  };

  window.updateCart = () => {
    const items = Object.values(window.order);
    const totalQty = items.reduce((s,i)=>s + i.quantity, 0);
    const subtotal = items.reduce((s,i)=>s + (i.price * i.quantity), 0);
    const discountAmount = Math.round(subtotal * (currentDiscount/100));
    const tax = Math.round((subtotal - discountAmount) * TAX_RATE);
    const total = subtotal - discountAmount + tax;

    // update cart visible count
    const cartCountEl = document.getElementById("cartCount");
    const cartBtn = document.getElementById("cartButton");
    if (totalQty > 0) {
      cartBtn.style.display = 'inline-block';
      cartCountEl.innerText = totalQty;
    } else {
      cartBtn.style.display = 'none';
      cartCountEl.innerText = 0;
    }

    // order items listing
    const orderItemsEl = document.getElementById("orderItems");
    if (items.length === 0) {
      orderItemsEl.innerHTML = "<p style='text-align:left;color:#444'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>";
    } else {
      orderItemsEl.innerHTML = items.map(it => `
        <div class="order-item">
          <div>
            <div style="font-weight:700">${escapeHtml(it.name)} x ${it.quantity}</div>
            <div style="font-size:0.9rem;color:#666">${it.price} ‡∏ø / ‡∏ä‡∏¥‡πâ‡∏ô</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800">${it.price*it.quantity} ‡∏ø</div>
            <div style="margin-top:6px">
              <button onclick="decQty('${it.id}')" style="margin-right:6px;padding:4px 6px">-</button>
              <button onclick="incQty('${it.id}')" style="padding:4px 6px">+</button>
            </div>
          </div>
        </div>
      `).join('');
    }

    document.getElementById("totalSummary").innerText = `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} ‡∏ø`;
    return { items, subtotal, discountAmount, tax, total, totalQty };
  };

  window.incQty = (id) => { playClick(); if (window.order[id]) { window.order[id].quantity++; updateCart(); } };
  window.decQty = (id) => { playClick(); if (window.order[id]) { window.order[id].quantity--; if (window.order[id].quantity <=0) delete window.order[id]; updateCart(); } };

  window.showCart = () => {
    const data = updateCart();
    if (!data || data.totalQty === 0) { alert("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤"); return; }
    // ensure order summary is visible (we keep it visible on desktop)
    // Center focus or highlight can be implemented; here we just play click.
    playClick();
    window.scrollTo({top:0,behavior:'smooth'});
  };

  function closeCart(){
    // just collapse mobile: on mobile orderSummary is sticky; we do nothing
    playClick();
  }

  // ---------------- Discount Auth / apply discount ----------------
  function promptDiscountAuth(){
    // open popup with PIN keypad; after success call applyDiscount(percent)
    showPopup('authPopup');
  }

  // Append pin
  function appendPin(v){
    const el = document.getElementById('pinInput');
    if (el.value.length >= 6) return;
    el.value += v;
    playClick();
  }
  function clearPin(){ document.getElementById('pinInput').value = ''; }
  function submitPin(){
    playClick();
    const val = document.getElementById('pinInput').value;
    if (val === DISCOUNT_PIN){
      closeAllPopups();
      // show discount options as confirm dialog simple
      const pct = prompt("‡πÉ‡∏™‡πà‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (5,10,15,20):", "5");
      const num = Number(pct);
      if (DISCOUNT_OPTIONS.includes(num)){
        applyDiscount(num);
      } else {
        alert("‡πÄ‡∏õ‡∏≠‡∏£‡πå‡πÄ‡∏ã‡πá‡∏ô‡∏ï‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    } else {
      alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
    }
    clearPin();
  }

  function applyDiscount(pct){
    currentDiscount = pct;
    discountAuthorized = true;
    playClick();
    updateCart();
    alert(`‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ${pct}% ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
  }

  function removeDiscount(){
    currentDiscount = 0;
    discountAuthorized = false;
    playClick();
    updateCart();
  }

  // ----------------- Payment flows -----------------
  function payCash(){
    const { total } = updateCart();
    if (!total || total <=0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"); return; }
    currentPaymentMethod = 'cash';
    document.getElementById('cashAmount').innerText = total;
    document.getElementById('cashInput').value = '';
    document.getElementById('changeDisplay').innerText = '';
    showPopup('cashPopup');
  }

  function appendCash(v){
    const el = document.getElementById('cashInput');
    el.value = (el.value || '') + v;
    playClick();
  }
  function clearCash(){ document.getElementById('cashInput').value = ''; document.getElementById('changeDisplay').innerText = ''; playClick(); }

  async function confirmCash(){
    playClick();
    const paid = Number(document.getElementById('cashInput').value || 0);
    const { total } = updateCart();
    if (isNaN(paid) || paid < total) { alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞"); return; }
    const change = paid - total;
    document.getElementById('changeDisplay').innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change} ‡∏ø`;
    // finalize receipt: show receipt & save
    await finalizePayment('cash', { paid, change });
    setTimeout(()=>{ closeAllPopups(); alert("‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!"); }, 400);
  }

  function payQR(){
    const { total } = updateCart();
    if (!total || total <=0) { alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠"); return; }
    currentPaymentMethod = 'qr';
    document.getElementById('qrAmount').innerText = total;
    // If have QR image configured, set src; else leave placeholder
    // For now we hide qrImage if not configured.
    const qrImg = document.getElementById('qrImage');
    const qrPlaceholder = document.getElementById('qrPlaceholder');
    // If you later store a qr url in config, set qrImg.src = '...'; qrImg.style.display='block'; qrPlaceholder.style.display='none';
    qrImg.style.display='none';
    qrPlaceholder.style.display='flex';
    showPopup('qrPopup');
  }

  async function confirmQR(){
    playClick();
    await finalizePayment('qr', {});
    closeAllPopups();
    alert("‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô QR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
  }

  // Finalize payment: show receipt and save to supabase
  async function finalizePayment(method, extra){
    const { items, subtotal, discountAmount, tax, total } = updateCart();
    if (!items || items.length === 0) return;
    // build receipt content
    const now = new Date().toISOString();
    const receipt = {
      total,
      subtotal,
      tax,
      discount_percent: currentDiscount,
      discount_amount: discountAmount,
      payment_method: method,
      created_at: now
    };

    // Show receipt popup
    renderReceiptPopup(receipt, items, extra);
    showPopup('receiptPopup');

    // Save receipt and items to supabase
    try {
      const { data:receiptData, error:receipErr } = await supabase
        .from('receipts')
        .insert([{
          total: receipt.total,
          subtotal: receipt.subtotal,
          tax: receipt.tax,
          discount_percent: receipt.discount_percent,
          discount_amount: receipt.discount_amount,
          payment_method: receipt.payment_method,
          created_at: receipt.created_at
        }]).select().single();

      if (receipErr) { console.error("Insert receipt error", receipErr); /* continue */ }
      const receipt_id = receiptData ? receiptData.id : null;

      // insert receipt items
      const itemsToInsert = items.map(i => ({ receipt_id, menu_id: i.id, name: i.name, price: i.price, quantity: i.quantity, total: i.price*i.quantity }));
      if (itemsToInsert.length>0) {
        const { error: itemsErr } = await supabase.from('receipt_items').insert(itemsToInsert);
        if (itemsErr) console.error("Insert receipt_items error", itemsErr);
      }
    } catch (err) {
      console.error("save receipt error", err);
    }

    // reset cart after a short delay
    setTimeout(()=>{ window.order = {}; currentDiscount = 0; discountAuthorized=false; updateCart(); }, 900);
  }

  function renderReceiptPopup(receipt, items, extra){
    const details = document.getElementById('receiptDetails');
    const table = document.getElementById('receiptTable');
    // header
    details.innerHTML = `<div style="text-align:center;font-weight:700">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleString()}</div><div style="text-align:center;margin-bottom:8px">‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${receipt.payment_method.toUpperCase()}</div>`;
    // build rows
    let rows = `<tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="text-align:right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th style="text-align:right">‡∏£‡∏ß‡∏°</th></tr>`;
    items.forEach(it => {
      rows += `<tr><td>${escapeHtml(it.name)}</td><td style="text-align:right">${it.quantity}</td><td style="text-align:right">${it.price*it.quantity} ‡∏ø</td></tr>`;
    });
    rows += `<tr><td colspan="2" style="text-align:right">‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢</td><td style="text-align:right">${receipt.subtotal} ‡∏ø</td></tr>`;
    rows += `<tr><td colspan="2" style="text-align:right">‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${receipt.discount_percent}%)</td><td style="text-align:right">-${receipt.discount_amount} ‡∏ø</td></tr>`;
    rows += `<tr><td colspan="2" style="text-align:right">‡∏†‡∏≤‡∏©‡∏µ ${TAX_RATE*100}%</td><td style="text-align:right">${receipt.tax} ‡∏ø</td></tr>`;
    rows += `<tr><td colspan="2" style="text-align:right;font-weight:800">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏™‡∏¥‡πâ‡∏ô</td><td style="text-align:right;font-weight:800">${receipt.total} ‡∏ø</td></tr>`;
    table.innerHTML = rows;
  }

  function printReceipt(){
    window.print();
  }
  function closeReceipt(){ closeAllPopups(); }

  // Utility popups
  function showPopup(id){
    document.getElementById('overlay').style.display = 'block';
    document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
    document.getElementById(id).style.display = 'block';
  }
  function closeAllPopups(){
    document.getElementById('overlay').style.display = 'none';
    document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
  }

  // navigation
  function goHome(){ window.location.href = 'index.html'; }
  function goBack(){ window.history.back(); }

  // ======= Audio click using WebAudio (avoid external file 404) =======
  let audioCtx = null;
  function playClick(){
    try{
      if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'square';
      o.frequency.setValueAtTime(800, audioCtx.currentTime);
      g.gain.setValueAtTime(0.0001, audioCtx.currentTime);
      g.gain.exponentialRampToValueAtTime(0.08, audioCtx.currentTime + 0.001);
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      setTimeout(()=>{ o.stop(); }, 60);
    }catch(e){
      console.log("audio not supported", e);
    }
  }

  // escape a bit for onclick JSON (already used JSON.stringify for names)
  window.appendCash = appendCash;
  window.clearCash = clearCash;
  window.confirmCash = confirmCash;

  // initial load
  loadMenu().then(()=>{ updateCart(); });

  // Helper: if you want to programmatically set a QR image url:
  window.setQRImage = (url) => {
    const img = document.getElementById('qrImage');
    const ph = document.getElementById('qrPlaceholder');
    if (url) { img.src = url; img.style.display='block'; ph.style.display='none'; }
    else { img.style.display='none'; ph.style.display='flex'; }
  };

  // small helper for outside (you used these earlier)
  window.removeDiscount = removeDiscount;
  window.promptDiscountAuth = promptDiscountAuth;
  window.applyDiscount = applyDiscount;

  // Save receipt helper (optional, for external calls)
  window.saveReceiptToSupabase = async function(receiptObj, itemsArray){
    const { data, error } = await supabase.from('receipts').insert([receiptObj]).select().single();
    if (error) throw error;
    const rid = data.id;
    const { error: err2 } = await supabase.from('receipt_items').insert(itemsArray.map(i=>({...i, receipt_id:rid})));
    if (err2) throw err2;
    return data;
  };

</script>
</body>
</html>