<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --orange:#FFA500;--orange-2:#FFB84D;--blue:#0047AB;--blue-2:#0066CC;--white:#FFFFFF;--glass:rgba(255,255,255,0.9)
    }
    *{box-sizing:border-box}
    body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,var(--orange) 0%,#fff 60%,var(--blue));color:#002366;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:transparent;gap:10px}
    .btn-nav{padding:8px 14px;border:none;border-radius:10px;background:var(--glass);color:#002366;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.06);transition:transform .15s}
    .btn-nav:hover{transform:translateY(-2px)}
    h1{text-align:center;margin:8px 0 12px;font-size:1.6rem;color:#002366}
    .container{display:flex;gap:12px;padding:12px;align-items:flex-start}
    .order-summary{width:320px;background:var(--glass);border-radius:16px;padding:14px;margin-right:8px;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.1);border:1px solid rgba(0,0,0,0.05)}
    .order-summary h3{margin:0 0 8px}
    .order-item{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:6px 0;background:#fff;border-radius:8px}
    .order-summary .total{margin-top:12px;font-weight:800;color:#002366;text-align:center}
    .order-summary .actions button{width:100%;margin:8px 0;padding:10px;border:none;border-radius:8px;font-weight:700;cursor:pointer}
    .order-summary .actions button.btn-add{background:linear-gradient(90deg,var(--orange),var(--orange-2));color:#002366}
    .order-summary .actions button.btn-cash{background:#4CAF50;color:white}
    .order-summary .actions button.btn-qr{background:#0b5ed7;color:white}
    .order-summary .actions button.btn-cancel{background:#f44336;color:white}
    .menu-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:18px;align-items:start}
    .menu-item{background:#fff;border-radius:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.08);padding:16px;cursor:pointer;transition:transform .14s}
    .menu-item:hover{transform:translateY(-6px)}
    .image-placeholder{width:100%;height:140px;background:#eee;border-radius:12px;display:flex;align-items:center;justify-content:center;color:#9aa; margin-bottom:12px}
    .menu-item h3{margin:8px 0 6px;font-size:1.05rem;color:#024}
    .menu-item .cat{color:#666;margin-bottom:8px}
    .price{color:#0047AB;font-weight:800;font-size:1.05rem}
    .cart-button{position:fixed;bottom:18px;right:18px;background:linear-gradient(90deg,#0047AB,#0066CC);color:white;border-radius:50px;padding:12px 18px;font-size:1.1rem;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1100;cursor:pointer;border:none}
    .cart-button:hover{transform:scale(1.05)}
    .cart-button span{background:#FF4500;border-radius:12px;padding:2px 6px;font-size:.9rem;margin-left:8px}
    .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,0.25);z-index:1000;width:360px;max-width:96%;text-align:center;display:none}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;z-index:999}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .keypad button{padding:14px;font-size:1.1rem;border-radius:10px;border:none;background:var(--orange);color:white;font-weight:700;cursor:pointer}
    .keypad button:hover{background:var(--orange-2)}
    .receipt-table{width:100%;border-collapse:collapse;margin-top:10px}
    .receipt-table td{padding:6px 6px;border-bottom:1px dashed rgba(0,0,0,0.1)}
    /* responsive for mobile */
    @media (max-width: 800px){
      .container{flex-direction:column}
      .order-summary{position:sticky;top:0;width:100%;z-index:1000;margin:0 0 12px 0;border-radius:0 0 14px 14px}
      .menu-grid{grid-template-columns:repeat(2,1fr)}
      .image-placeholder{height:120px}
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>

  <header>
    <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
    <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
  </header>

  <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>

  <div class="container">
    <div class="order-summary" id="orderSummary" style="display:none;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
      <div id="orderItems"></div>
      <div class="total" id="totalSummary">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ø</div>
      <div class="actions">
        <button class="btn-add" onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
        <button class="btn-cash" onclick="playClick(); promptCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
        <button class="btn-qr" onclick="playClick(); payQR()">üì± QR Code</button>
        <button class="btn-cancel" onclick="playClick(); cancelOrder()">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      </div>
    </div>

    <div class="menu-grid" id="menuGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</div>
  </div>

  <button class="cart-button" id="cartButton" onclick="playClick(); showCart()" style="display:none;">
    üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <span id="cartCount">0</span>
  </button>

  <!-- CASH POPUP with keypad -->
  <div class="popup" id="cashPopup">
    <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
    <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount">0</span> ‡∏ø</strong></p>
    <input id="cashInput" type="text" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" readonly style="width:95%;padding:10px;border-radius:8px;border:1px solid #ccc;text-align:center;font-size:1.1rem"/>
    <div class="keypad" style="margin-top:12px;">
      <button onclick="appendCash('1')">1</button><button onclick="appendCash('2')">2</button><button onclick="appendCash('3')">3</button>
      <button onclick="appendCash('4')">4</button><button onclick="appendCash('5')">5</button><button onclick="appendCash('6')">6</button>
      <button onclick="appendCash('7')">7</button><button onclick="appendCash('8')">8</button><button onclick="appendCash('9')">9</button>
      <button onclick="clearCash()">C</button><button onclick="appendCash('0')">0</button><button onclick="confirmCash()">‚úÖ</button>
    </div>
    <p id="changeDisplay" style="margin-top:12px;font-weight:700;color:#4CAF50"></p>
  </div>

  <!-- QR POPUP -->
  <div class="popup" id="qrPopup">
    <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <img id="qrImage" src="kshop.jpg" alt="QR" style="width:170px;border-radius:8px;margin-bottom:10px" onerror="this.style.display='none'">
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount">0</span> ‡∏ø</strong></p>
    <button onclick="playClick(); confirmQR()" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:700">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
  </div>

  <!-- Discount auth popup -->
  <div class="popup" id="discountAuthPopup">
    <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
    <input id="pinInput" type="password" maxlength="6" readonly style="width:90%;padding:10px;border-radius:8px;border:1px solid #ccc;text-align:center;font-size:1.2rem"/>
    <div class="keypad" style="margin-top:12px;">
      <button onclick="appendPin('1')">1</button><button onclick="appendPin('2')">2</button><button onclick="appendPin('3')">3</button>
      <button onclick="appendPin('4')">4</button><button onclick="appendPin('5')">5</button><button onclick="appendPin('6')">6</button>
      <button onclick="appendPin('7')">7</button><button onclick="appendPin('8')">8</button><button onclick="appendPin('9')">9</button>
      <button onclick="clearPin()">C</button><button onclick="appendPin('0')">0</button><button onclick="submitPin()">‚úÖ</button>
    </div>
    <div style="margin-top:12px;display:flex;gap:8px;justify-content:center;flex-wrap:wrap;">
      <button onclick="playClick(); applyDiscount(5)" style="padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,#FFA500,#FFB84D);border:none;color:#002366;font-weight:700">5%</button>
      <button onclick="playClick(); applyDiscount(10)" style="padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,#FFB84D,#FFD27F);border:none;color:#002366;font-weight:700">10%</button>
      <button onclick="playClick(); applyDiscount(15)" style="padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,#FFB84D,#FFC04D);border:none;color:#002366;font-weight:700">15%</button>
      <button onclick="playClick(); applyDiscount(20)" style="padding:8px 12px;border-radius:8px;background:linear-gradient(90deg,#FF9A3C,#FF6B00);border:none;color:white;font-weight:700">20%</button>
    </div>
  </div>

  <!-- Receipt popup -->
  <div class="popup" id="receiptPopup">
    <h3>‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <div id="receiptDetails" style="text-align:left"></div>
    <div style="display:flex;gap:8px;margin-top:12px;">
      <button onclick="playClick(); window.print()" style="flex:1;padding:10px;border-radius:8px;border:none;background:linear-gradient(90deg,#4CAF50,#45A049);color:#fff;font-weight:700">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
      <button onclick="playClick(); closeReceipt()" style="flex:1;padding:10px;border-radius:8px;border:none;background:#999;color:#fff;font-weight:700">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </div>

  <!-- click sound -->
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>

  <!-- Supabase + App logic -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // --- CONFIG: ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ‡πÅ‡∏•‡πâ‡∏ß) ---
    const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    const menuGrid = document.getElementById("menuGrid");

    // global order object
    window.order = {}; // key: id -> {id,name,price,quantity}
    window.currentDiscount = { percent: 0, code: null };

    // load menu from supabase (only available = true)
    async function loadMenu(){
      try{
        menuGrid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...";
        const { data, error } = await supabase
          .from("menu")
          .select("id,name,price,category,image,available")
          .eq("available", true)
          .order("id", { ascending: true });

        if (error) {
          console.error("Supabase load error:", error);
          menuGrid.innerHTML = "<p style='text-align:center;color:red'>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>";
          return;
        }
        if (!data || data.length === 0) {
          menuGrid.innerHTML = "<p style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>";
          return;
        }

        // render cards: if image not provided, show placeholder text "‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ"
        menuGrid.innerHTML = data.map(item => {
          const imageHtml = item.image ? `<div class="image-placeholder"><img src="${item.image}" alt="${escapeHtml(item.name)}" style="width:100%;height:100%;object-fit:cover;border-radius:10px" onerror="this.style.display='none'"></div>` :
            `<div class="image-placeholder">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>`;
          return `
            <div class="menu-item" onclick="window.addToCart('${item.id}','${escapeJs(item.name)}',${Number(item.price)})">
              ${imageHtml}
              <h3>${escapeHtml(item.name)}</h3>
              <div class="cat">${escapeHtml(item.category || "")}</div>
              <div class="price">${Number(item.price)} ‡∏ø</div>
            </div>
          `;
        }).join("");
      } catch (err) {
        console.error("Error:", err);
        menuGrid.innerHTML = "<p style='text-align:center;color:red'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>";
      }
    }

    // escape helpers to avoid breaking strings
    function escapeJs(s){
      if (!s) return "";
      return s.replace(/'/g, "\\'").replace(/\n/g, "\\n").replace(/\r/g, "");
    }
    function escapeHtml(s){
      if(!s) return "";
      return s.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
    }

    // add to cart
    window.addToCart = function(id, name, price){
      playClick();
      if(!window.order[id]) window.order[id] = { id, name, price, quantity:0 };
      window.order[id].quantity++;
      updateCart();
    }

    // update cart UI & summary
    window.updateCart = function(){
      const items = Object.values(window.order);
      const totalQty = items.reduce((s,i)=>s+i.quantity,0);
      const subtotal = items.reduce((s,i)=>s + (i.price * i.quantity), 0);

      // show hide cart button
      if(totalQty > 0){
        document.getElementById("cartButton").style.display = "block";
        document.getElementById("cartCount").innerText = totalQty;
      } else {
        document.getElementById("cartButton").style.display = "none";
        document.getElementById("orderSummary").style.display = "none";
      }

      // render order items in summary
      if(items.length > 0){
        document.getElementById("orderSummary").style.display = "block";
        document.getElementById("orderItems").innerHTML = items.map(it => {
          return `<div class="order-item">
                    <div style="flex:1">${escapeHtml(it.name)} x ${it.quantity}</div>
                    <div style="min-width:80px;text-align:right">${it.price * it.quantity} ‡∏ø</div>
                    <div style="margin-left:8px">
                      <button onclick="playClick(); changeQty('${it.id}', -1)" style="padding:6px;border-radius:6px;border:none;background:#eee;cursor:pointer">-</button>
                      <button onclick="playClick(); changeQty('${it.id}', 1)" style="padding:6px;border-radius:6px;border:none;background:#eee;cursor:pointer">+</button>
                    </div>
                  </div>`;
        }).join("");
      } else {
        document.getElementById("orderItems").innerHTML = "<p style='text-align:center;color:#666'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>";
      }

      // calculate totals with discount and tax (7%)
      const discount = window.currentDiscount.percent || 0;
      const discAmount = Math.round(subtotal * (discount/100));
      const subtotalAfterDisc = subtotal - discAmount;
      const tax = Math.round(subtotalAfterDisc * 0.07);
      const total = subtotalAfterDisc + tax;

      document.getElementById("totalSummary").innerText = `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} ‡∏ø`;
      // store numbers into attributes for payment UIs
      document.getElementById("totalSummary").dataset.subtotal = subtotal;
      document.getElementById("totalSummary").dataset.discount = discAmount;
      document.getElementById("totalSummary").dataset.tax = tax;
      document.getElementById("totalSummary").dataset.total = total;
    }

    window.changeQty = function(id, delta){
      if(!window.order[id]) return;
      window.order[id].quantity += delta;
      if(window.order[id].quantity <= 0) delete window.order[id];
      updateCart();
    }

    // show cart popup
    window.showCart = function(){
      const items = Object.values(window.order);
      if(items.length === 0){
        alert("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
        return;
      }
      document.getElementById("orderSummary").style.display = "block";
    }

    // close cart summary
    window.closeCart = function(){
      document.getElementById("orderSummary").style.display = "none";
    }

    // payment - cash flow
    window.promptCash = function(){
      const total = Number(document.getElementById("totalSummary").dataset.total || 0);
      document.getElementById("cashAmount").innerText = total;
      document.getElementById("cashInput").value = "";
      document.getElementById("changeDisplay").innerText = "";
      showPopup("cashPopup");
    }
    function appendCash(v){ document.getElementById("cashInput").value += v; }
    function clearCash(){ document.getElementById("cashInput").value = ""; document.getElementById("changeDisplay").innerText = ""; }
    window.confirmCash = function(){
      const paid = Number(document.getElementById("cashInput").value || 0);
      const total = Number(document.getElementById("totalSummary").dataset.total || 0);
      if(paid < total){ alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î"); return; }
      const change = paid - total;
      document.getElementById("changeDisplay").innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change} ‡∏ø`;
      setTimeout(()=> {
        closeAllPopups();
        showReceiptAndReset("‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î", paid);
      }, 800);
    }

    // payment - QR
    window.payQR = function(){
      const total = Number(document.getElementById("totalSummary").dataset.total || 0);
      document.getElementById("qrAmount").innerText = total;
      showPopup("qrPopup");
    }
    window.confirmQR = function(){
      closeAllPopups();
      showReceiptAndReset("QR Code", null);
    }

    // receipt display and reset order
    function showReceiptAndReset(method, paidAmount){
      const items = Object.values(window.order);
      const subtotal = Number(document.getElementById("totalSummary").dataset.subtotal || 0);
      const discount = Number(document.getElementById("totalSummary").dataset.discount || 0);
      const tax = Number(document.getElementById("totalSummary").dataset.tax || 0);
      const total = Number(document.getElementById("totalSummary").dataset.total || 0);

      let html = `<div style="text-align:center;font-weight:800;color:#0047AB;margin-bottom:8px">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</div>`;
      html += `<table class="receipt-table">`;
      items.forEach(it=>{
        html += `<tr><td style="width:65%">${escapeHtml(it.name)} x ${it.quantity}</td><td style="text-align:right">${it.price * it.quantity} ‡∏ø</td></tr>`;
      });
      html += `<tr><td>‡∏£‡∏ß‡∏°‡∏¢‡πà‡∏≠‡∏¢</td><td style="text-align:right">${subtotal} ‡∏ø</td></tr>`;
      html += `<tr><td>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</td><td style="text-align:right">-${discount} ‡∏ø</td></tr>`;
      html += `<tr><td>‡∏†‡∏≤‡∏©‡∏µ 7%</td><td style="text-align:right">${tax} ‡∏ø</td></tr>`;
      html += `<tr><td style="font-weight:800">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</td><td style="text-align:right;font-weight:800">${total} ‡∏ø</td></tr>`;
      if(paidAmount !== null){
        html += `<tr><td>‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</td><td style="text-align:right">${paidAmount} ‡∏ø</td></tr>`;
        html += `<tr><td>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô</td><td style="text-align:right">${paidAmount - total} ‡∏ø</td></tr>`;
      } else {
        html += `<tr><td>‡∏ä‡πà‡∏≠‡∏á‡∏ó‡∏≤‡∏á‡∏ä‡∏≥‡∏£‡∏∞</td><td style="text-align:right">${method}</td></tr>`;
      }
      html += `</table>`;
      document.getElementById("receiptDetails").innerHTML = html;
      showPopup("receiptPopup");

      // reset
      window.order = {};
      window.currentDiscount = { percent:0, code:null };
      updateCart();
    }

    window.closeReceipt = function(){
      closeAllPopups();
      // go to index or just hide: we keep on same page
      // window.location.href = "index.html"; // uncomment if you want return to index.html automatically
    }

    // cancel order
    window.cancelOrder = function(){
      if(confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")){
        window.order = {};
        window.currentDiscount = { percent:0, code:null };
        updateCart();
        closeCart();
      }
    }

    // Discount flow
    function promptDiscountAuth(){
      // open discount auth popup
      showPopup("discountAuthPopup");
    }

    // PIN keypad for discount
    function appendPin(v){ document.getElementById("pinInput").value += v; }
    function clearPin(){ document.getElementById("pinInput").value = ""; }
    function submitPin(){
      // simple check (you can change to fetch/check against DB)
      const pin = document.getElementById("pinInput").value;
      // default master code = "1234" (change as needed)
      if(pin === "1234"){
        alert("‡∏£‡∏´‡∏±‡∏™‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÑ‡∏î‡πâ");
        // do nothing here, discount buttons below will call applyDiscount
      } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
      }
    }

    // Apply discount percent (only allowed after pin)
    function applyDiscount(percent){
      const pin = document.getElementById("pinInput").value;
      if(pin !== "1234"){ alert("‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô (‡∏£‡∏´‡∏±‡∏™‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á = 1234)"); return; }
      window.currentDiscount = { percent: percent, code: pin };
      // refresh totals
      updateCart();
      closeAllPopups();
      alert(`‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ${percent}% ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢`);
    }

    // popup helper
    function showPopup(id){
      document.getElementById("overlay").style.display = "block";
      document.querySelectorAll(".popup").forEach(p=>p.style.display="none");
      document.getElementById(id).style.display = "block";
      // prevent background scroll (simple)
      document.body.style.overflow = "hidden";
    }
    function closeAllPopups(){
      document.getElementById("overlay").style.display = "none";
      document.querySelectorAll(".popup").forEach(p=>p.style.display="none");
      document.body.style.overflow = "";
    }

    // Sound
    function playClick(){
      try{
        const s = document.getElementById("clickSound");
        s.currentTime = 0;
        s.play().catch(e=>console.log("Audio play fail:", e));
      }catch(e){}
    }
    window.playClick = playClick; // make global

    // go home/back
    function goHome(){ window.location.href = "index.html"; }
    function goBack(){ window.history.back(); }

    // utility: close popups on ESC
    document.addEventListener('keydown', (e)=> {
      if(e.key === "Escape") closeAllPopups();
    });

    // initial load
    loadMenu();
    // make updateCart global call so other flows can call
    window.updateCart = window.updateCart;

  </script>

  <!-- Non-module helpers (goHome/back available globally as well) -->
  <script>
    // expose small functions to global scope
    window.goHome = function(){ try{ playClick(); }catch{}; window.location.href='index.html'; };
    window.goBack = function(){ try{ playClick(); }catch{}; window.history.back(); };
  </script>

</body>
</html>