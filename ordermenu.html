<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --orange:#FFA500; --orange-2:#FFB84D; --blue:#0047AB; --blue-2:#0066CC;
      --white:#FFFFFF; --glass:rgba(255,255,255,0.92);
      --card-bg:#fff6ee;
    }
    html,body{height:100%}
    body{font-family:'Prompt',sans-serif;
      background:linear-gradient(135deg,var(--orange) 0%,#ffffff 60%,var(--blue));
      color:#002366;margin:0;padding:0;-webkit-font-smoothing:antialiased}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:transparent;gap:10px}
    .btn-nav{padding:8px 14px;border:none;border-radius:10px;background:var(--glass);color:#002366;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.06);transition:transform .15s}
    .btn-nav:hover{transform:translateY(-2px)}
    h1{text-align:center;margin:8px 0 12px;font-size:1.5rem;color:#002366}
    .container{display:flex;gap:12px;padding:12px;align-items:flex-start}
    /* Order summary card */
    .order-summary{width:320px;background:var(--glass);border-radius:16px;padding:14px;margin-right:8px;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.1);border:1px solid rgba(0,0,0,0.05)}
    .order-summary h3{margin:0 0 8px}
    .order-item{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:4px 0;background:#fff;border-radius:8px}
    .order-summary .total{margin-top:10px;text-align:center;font-weight:700}
    .order-summary button{width:100%;margin:8px 0;padding:10px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;transition:transform .12s}
    .btn-add{background:linear-gradient(90deg,var(--orange),var(--orange-2));color:#002366}
    .btn-cash{background:#4CAF50;color:white}
    .btn-qr{background:#0B63A3;color:white}
    .btn-cancel{background:#f44336;color:white}
    .cart-button{position:fixed;bottom:18px;right:18px;background:linear-gradient(90deg,#0047AB,#0066CC);color:white;border-radius:50px;padding:12px 18px;font-size:1.1rem;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1100;cursor:pointer;border:none}
    .cart-button:hover{transform:scale(1.05)}
    .cart-button span{background:#FF4500;border-radius:12px;padding:2px 6px;font-size:.9rem;margin-left:8px}
    .menu-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;align-items:start;padding:6px}
    .menu-item{background:#fff;border-radius:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.08);padding:16px 12px;cursor:pointer;transition:transform .14s;min-height:240px;display:flex;flex-direction:column;justify-content:flex-start}
    .menu-item:hover{transform:translateY(-6px)}
    .image-block{width:100%;height:140px;background:linear-gradient(90deg,#f2f2f2,#e9e9e9);border-radius:10px;margin-bottom:12px;display:flex;align-items:center;justify-content:center;color:#888}
    .menu-item h3{margin:6px 0 4px;font-size:1.02rem;color:#003366}
    .menu-item p.cat{margin:0;font-size:.9rem;color:#666}
    .menu-item .price{margin-top:auto;font-weight:700;color:#0047AB;font-size:1.1rem}
    /* popup */
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;z-index:999}
    .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:18px;border-radius:12px;box-shadow:0 20px 50px rgba(0,0,0,0.25);z-index:1000;width:360px;max-width:92%;display:none;text-align:center}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:12px}
    .keypad button{padding:14px;border-radius:8px;border:none;background:var(--orange);color:white;font-weight:700;cursor:pointer;font-size:1rem}
    .keypad button.small{padding:10px 8px}
    /* receipt */
    #receiptPopup{width:360px;max-height:90vh;overflow-y:auto;text-align:left}
    #receiptPopup h2{color:#0047AB}
    .receipt-table{width:100%;border-collapse:collapse;margin-top:8px}
    .receipt-table th,.receipt-table td{padding:6px 8px;border-bottom:1px dashed rgba(0,0,0,0.12);font-size:.95rem}
    /* responsive mobile */
    @media (max-width:768px){
      .container{flex-direction:column}
      .order-summary{position:sticky;top:0;width:100%;z-index:1000;margin:0 0 10px 0;border-radius:0 0 12px 12px}
      .menu-grid{grid-template-columns:repeat(2,1fr)}
    }
    /* small touches */
    .btn-row{display:flex;gap:8px;justify-content:space-between;margin-top:10px}
    .small-btn{padding:8px 10px;border-radius:8px;border:none;cursor:pointer}
  </style>
</head>
<body>
  <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>

  <header>
    <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
    <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
  </header>

  <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>

  <div class="container">
    <div class="order-summary" id="orderSummary" style="display:none;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
      <div id="orderItems"></div>
      <div class="total" id="summaryTotal">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ø</div>

      <button class="btn-add" onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button class="btn-cash" onclick="playClick(); promptCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      <button class="btn-qr" onclick="playClick(); payQR()">üì± QR Code</button>
      <button class="btn-cancel" onclick="playClick(); cancelOrder()">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>

      <div style="margin-top:6px">
        <button class="small-btn" style="background:linear-gradient(90deg,#fff,#eee);width:100%" onclick="playClick(); promptDiscountAuth()">üéÅ ‡πÉ‡∏™‡πà‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
      </div>
    </div>

    <div class="menu-grid" id="menuGrid">
      ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...
    </div>
  </div>

  <button class="cart-button" id="cartButton" onclick="playClick(); showCart()" style="display:none;">
    üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <span id="cartCount">0</span>
  </button>

  <!-- CASH POPUP (keypad) -->
  <div class="popup" id="cashPopup">
    <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
    <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount">0</span> ‡∏ø</strong></p>
    <input type="text" id="cashInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" readonly style="width:90%;padding:10px;border-radius:8px;border:1px solid #ddd;text-align:center;font-size:1.1rem" />
    <div class="keypad" style="margin-top:12px;">
      <button onclick="playClick(); appendCash('1')">1</button><button onclick="playClick(); appendCash('2')">2</button><button onclick="playClick(); appendCash('3')">3</button>
      <button onclick="playClick(); appendCash('4')">4</button><button onclick="playClick(); appendCash('5')">5</button><button onclick="playClick(); appendCash('6')">6</button>
      <button onclick="playClick(); appendCash('7')">7</button><button onclick="playClick(); appendCash('8')">8</button><button onclick="playClick(); appendCash('9')">9</button>
      <button onclick="playClick(); clearCash()">C</button><button onclick="playClick(); appendCash('0')">0</button><button onclick="playClick(); confirmCash()">‚úÖ</button>
    </div>
    <p id="changeDisplay" style="margin-top:8px;font-weight:600;color:#4CAF50;"></p>
  </div>

  <!-- QR POPUP -->
  <div class="popup" id="qrPopup">
    <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <!-- ‡πÉ‡∏™‡πà‡∏†‡∏≤‡∏û QR ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ï‡∏≠‡∏ô‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á -->
    <div style="width:180px;height:180px;border-radius:12px;background:#f1f1f1;display:flex;align-items:center;justify-content:center;margin:0 auto 10px">
      <span style="color:#aaa">QR Placeholder</span>
    </div>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount">0</span> ‡∏ø</strong></p>
    <button style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px" onclick="playClick(); confirmQR()">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
  </div>

  <!-- DISCOUNT AUTH POPUP (PIN keypad) -->
  <div class="popup" id="authPopup">
    <h3>‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
    <input id="pinInput" type="password" maxlength="6" readonly style="width:90%;padding:10px;border-radius:8px;border:1px solid #ddd;text-align:center;font-size:1.2rem" />
    <div class="keypad" style="margin-top:12px">
      <button onclick="playClick(); appendPin('1')">1</button><button onclick="playClick(); appendPin('2')">2</button><button onclick="playClick(); appendPin('3')">3</button>
      <button onclick="playClick(); appendPin('4')">4</button><button onclick="playClick(); appendPin('5')">5</button><button onclick="playClick(); appendPin('6')">6</button>
      <button onclick="playClick(); appendPin('7')">7</button><button onclick="playClick(); appendPin('8')">8</button><button onclick="playClick(); appendPin('9')">9</button>
      <button onclick="playClick(); clearPin()">C</button><button onclick="playClick(); appendPin('0')">0</button><button onclick="playClick(); submitPin()">‚úÖ</button>
    </div>
  </div>

  <!-- DISCOUNT CHOICES -->
  <div class="popup" id="discountPopup">
    <h3>üéÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
    <div style="display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
      <button class="small-btn" style="background:linear-gradient(90deg,#FFA500,#FFB84D);padding:10px 16px" onclick="playClick(); applyDiscount(5)">5%</button>
      <button class="small-btn" style="background:linear-gradient(90deg,#FFD27F,#FFC04D);padding:10px 16px" onclick="playClick(); applyDiscount(10)">10%</button>
      <button class="small-btn" style="background:linear-gradient(90deg,#FFB84D,#FFA500);padding:10px 16px" onclick="playClick(); applyDiscount(15)">15%</button>
      <button class="small-btn" style="background:linear-gradient(90deg,#FF8A65,#FF5722);padding:10px 16px" onclick="playClick(); applyDiscount(20)">20%</button>
    </div>
    <div style="margin-top:10px"><button style="background:#999;color:#fff;padding:8px 10px;border-radius:8px;border:none" onclick="playClick(); removeDiscount()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button></div>
  </div>

  <!-- RECEIPT POPUP -->
  <div class="popup" id="receiptPopup">
    <div style="text-align:center;margin-bottom:8px">
      <img src="" id="receiptLogo" alt="" style="width:80px;display:none">
      <h3 style="margin:6px 0">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h3>
    </div>
    <div id="receiptDetails"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button style="flex:1;background:linear-gradient(90deg,#4CAF50,#45A049);color:white;border:none;padding:10px;border-radius:8px;font-weight:600" onclick="playClick(); window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
      <button style="flex:1;background:linear-gradient(90deg,#999,#777);color:white;border:none;padding:10px;border-radius:8px;font-weight:600" onclick="playClick(); closeReceipt()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>
  </div>

  <!-- click audio -->
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>

  <!-- Supabase + main script -->
  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // Supabase config (‡∏ï‡∏≤‡∏°‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì)
    const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    const menuGrid = document.getElementById("menuGrid");

    // Global order & settings
    window.order = {};
    let discountPercent = 0;
    let discountAuthOk = false;
    const DISCOUNT_PIN = "1122"; // ‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÑ‡∏î‡πâ)

    // TAX percent
    const TAX_PERCENT = 7;

    async function loadMenu(){
      try {
        menuGrid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...";
        const { data, error } = await supabase
          .from("menu")
          .select("id,name,price,category,image,available")
          .eq("available", true)
          .order("id", { ascending: true });

        if (error) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
          menuGrid.innerHTML = "<p style='color:red;text-align:center;'>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</p>";
          return;
        }

        if (!data || data.length === 0) {
          menuGrid.innerHTML = "<p style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>";
          return;
        }

        // Render menu (‡πÑ‡∏°‡πà‡πÇ‡∏ä‡∏ß‡πå‡∏£‡∏π‡∏õ‡∏Ç‡∏ì‡∏∞‡∏ô‡∏µ‡πâ ‚Äî ‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á)
        menuGrid.innerHTML = data.map(item => {
          // image area intentionally blank/placeholder (user will provide image later)
          return `
            <div class="menu-item" onclick="window.addToCart(${item.id}, ${JSON.stringify(item.name)}, ${item.price})">
              <div class="image-block">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ</div>
              <h3>${escapeHtml(item.name)}</h3>
              <p class="cat">${escapeHtml(item.category || '')}</p>
              <div class="price">${item.price} ‡∏ø</div>
            </div>
          `;
        }).join("");
      } catch (err) {
        console.error("Error loading menu:", err);
        menuGrid.innerHTML = "<p style='color:red;text-align:center;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</p>";
      }
    }

    // Helper: escape html
    function escapeHtml(s){ return (s+'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    // Cart functions (‡∏ï‡∏≤‡∏°‡πÄ‡∏î‡∏¥‡∏°)
    window.addToCart = function(id, name, price){
      playClick();
      if (!window.order[id]) window.order[id] = { id, name, price, quantity: 0 };
      window.order[id].quantity++;
      updateCart();
    }

    window.updateCart = function(){
      const items = Object.values(window.order);
      const total = items.reduce((s,i)=> s + i.price*i.quantity, 0);
      const qty = items.reduce((s,i)=> s + i.quantity, 0);

      // show/hide cart button
      if (qty > 0) {
        document.getElementById("cartButton").style.display = "block";
        document.getElementById("cartCount").innerText = qty;
        document.getElementById("orderSummary").style.display = "block";
      } else {
        document.getElementById("cartButton").style.display = "none";
        document.getElementById("orderSummary").style.display = "none";
      }

      // render items in summary
      if (items.length > 0) {
        document.getElementById("orderItems").innerHTML = items.map(it => `
          <div class="order-item">
            <div style="flex:1;">
              <div style="font-weight:600">${escapeHtml(it.name)}</div>
              <div style="font-size:.85rem;color:#666">x ${it.quantity}</div>
            </div>
            <div style="min-width:72px;text-align:right;">
              <div style="font-weight:700">${it.price * it.quantity} ‡∏ø</div>
              <div style="margin-top:6px">
                <button class="small-btn" style="background:#eee" onclick="playClick(); decrement(${it.id})">‚àí</button>
                <button class="small-btn" style="background:#eee" onclick="playClick(); increment(${it.id})">+</button>
                <button class="small-btn" style="background:#f8d7da" onclick="playClick(); removeItem(${it.id})">‡∏•‡∏ö</button>
              </div>
            </div>
          </div>
        `).join("");
      } else {
        document.getElementById("orderItems").innerHTML = "<p style='text-align:center;color:#666'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</p>";
      }

      // calculate totals with discount and tax
      const subtotal = total;
      const discountAmt = Math.round(subtotal * (discountPercent/100));
      const taxable = Math.max(0, subtotal - discountAmt);
      const tax = Math.round(taxable * (TAX_PERCENT/100));
      const grandTotal = taxable + tax;

      // update total display (show breakdown)
      document.getElementById("summaryTotal").innerHTML = `
        <div style="font-size:1rem">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: <strong>${grandTotal}</strong> ‡∏ø</div>
        <div style="font-size:.9rem;color:#666;margin-top:6px">
          (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ ${TAX_PERCENT}% ‡∏´‡∏•‡∏±‡∏á‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ${discountPercent}%)
        </div>
      `;

      // for cash/qr popups
      document.getElementById("cashAmount").innerText = grandTotal;
      document.getElementById("qrAmount").innerText = grandTotal;
      // store computed amounts for use when confirming payments
      window._cartTotals = { subtotal, discountAmt, tax, grandTotal };
    }

    // increment/decrement/remove
    window.increment = id => { window.order[id].quantity++; updateCart(); }
    window.decrement = id => {
      if (!window.order[id]) return;
      window.order[id].quantity--;
      if (window.order[id].quantity <= 0) delete window.order[id];
      updateCart();
    }
    window.removeItem = id => { delete window.order[id]; updateCart(); }

    window.showCart = function(){
      const items = Object.values(window.order);
      if (items.length === 0) { alert("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤"); return; }
      document.getElementById("orderSummary").style.display = "block";
    }

    // Cash keypad functions
    function promptCash(){
      const totals = window._cartTotals || { grandTotal:0 };
      document.getElementById("cashAmount").innerText = totals.grandTotal;
      document.getElementById("cashInput").value = "";
      document.getElementById("changeDisplay").innerText = "";
      showPopup("cashPopup");
    }
    function appendCash(v){
      const el = document.getElementById("cashInput");
      el.value = (el.value === "0") ? v : el.value + v;
    }
    function clearCash(){ document.getElementById("cashInput").value = ""; document.getElementById("changeDisplay").innerText = ""; }
    function confirmCash(){
      const paid = Number(document.getElementById("cashInput").value || 0);
      const totals = window._cartTotals || { grandTotal:0 };
      if (paid < totals.grandTotal) { alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞"); return; }
      const change = paid - totals.grandTotal;
      document.getElementById("changeDisplay").innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change} ‡∏ø`;
      setTimeout(()=> {
        closeAllPopups();
        alert("üíµ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        printReceiptAndClear('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', paid);
      }, 900);
    }

    // QR
    function payQR(){
      const totals = window._cartTotals || { grandTotal:0 };
      document.getElementById("qrAmount").innerText = totals.grandTotal;
      showPopup("qrPopup");
    }
    function confirmQR(){
      closeAllPopups();
      alert("üì± ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô QR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      printReceiptAndClear('QR', window._cartTotals.grandTotal);
    }

    // Receipt printer + clear cart
    function printReceiptAndClear(method, paidAmount){
      // build receipt html
      const items = Object.values(window.order);
      const totals = window._cartTotals || { subtotal:0, discountAmt:0, tax:0, grandTotal:0 };
      let html = `<h2 style="text-align:center">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h2>`;
      html += `<div>‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà: ${new Date().toLocaleString()}</div>`;
      html += `<table class="receipt-table">`;
      html += `<thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th style="text-align:right">‡∏£‡∏≤‡∏Ñ‡∏≤</th></tr></thead><tbody>`;
      items.forEach(it=>{
        html += `<tr><td>${escapeHtml(it.name)} x${it.quantity}</td><td style="text-align:right">${it.price * it.quantity} ‡∏ø</td></tr>`;
      });
      html += `</tbody></table>`;
      html += `<div style="margin-top:8px">‡∏¢‡∏≠‡∏î‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏±‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${totals.subtotal} ‡∏ø</div>`;
      html += `<div>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: -${totals.discountAmt} ‡∏ø (${discountPercent}%)</div>`;
      html += `<div>‡∏†‡∏≤‡∏©‡∏µ ${TAX_PERCENT}%: ${totals.tax} ‡∏ø</div>`;
      html += `<div style="font-weight:700;margin-top:8px">‡∏£‡∏ß‡∏°‡∏ä‡∏≥‡∏£‡∏∞: ${totals.grandTotal} ‡∏ø</div>`;
      if (method === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' && paidAmount !== undefined) {
        html += `<div>‡∏ä‡∏≥‡∏£‡∏∞: ${paidAmount} ‡∏ø</div><div>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${paidAmount - totals.grandTotal} ‡∏ø</div>`;
      }
      html += `<div style="margin-top:10px;text-align:center">‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô</div>`;

      document.getElementById("receiptDetails").innerHTML = html;
      showPopup("receiptPopup");

      // clear
      window.order = {};
      discountPercent = 0;
      discountAuthOk = false;
      updateCart();
    }

    function closeReceipt(){ closeAllPopups(); window.location.href = "index.html"; }

    // Discount flow: require PIN to open discount choices
    function promptDiscountAuth(){
      // show pin popup
      document.getElementById("pinInput").value = "";
      showPopup("authPopup");
    }
    function appendPin(v){
      const el = document.getElementById("pinInput");
      el.value = (el.value||"") + v;
    }
    function clearPin(){ document.getElementById("pinInput").value = ""; }
    function submitPin(){
      const v = document.getElementById("pinInput").value || "";
      if (v === DISCOUNT_PIN) {
        discountAuthOk = true;
        closeAllPopups();
        // Show discount choices
        showPopup("discountPopup");
      } else {
        alert("‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
        document.getElementById("pinInput").value = "";
      }
    }
    function applyDiscount(pct){
      if (!discountAuthOk) { alert("‡∏ï‡πâ‡∏≠‡∏á‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏£‡∏´‡∏±‡∏™‡∏Å‡πà‡∏≠‡∏ô"); return; }
      discountPercent = pct;
      discountAuthOk = false;
      closeAllPopups();
      playClick();
      updateCart();
    }
    function removeDiscount(){
      discountPercent = 0;
      discountAuthOk = false;
      closeAllPopups();
      updateCart();
    }

    // Popup helpers
    function showPopup(id){
      document.getElementById("overlay").style.display = 'block';
      document.getElementById(id).style.display = 'block';
    }
    function closeAllPopups(){
      document.getElementById("overlay").style.display = 'none';
      document.querySelectorAll('.popup').forEach(p=>p.style.display='none');
    }

    // audio click
    function playClick(){
      try {
        const s = document.getElementById("clickSound");
        s.currentTime = 0;
        s.play().catch(()=>{ /* ignore autoplay */ });
      } catch(e){}
    }

    // Navigation
    function goHome(){ window.location.href = "index.html"; }
    function goBack(){ window.history.back(); }

    // Cancel order
    function cancelOrder(){
      if (!confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) return;
      window.order = {};
      discountPercent = 0;
      discountAuthOk = false;
      updateCart();
      closeAllPopups();
    }

    // init
    loadMenu();
    updateCart();
  </script>

  <!-- Non-module helpers for popup & printing (some duplicated intentionally to access from inline onclick) -->
  <script>
    // exposing helpers to inline onclick (already exported above via window.*)
    window.promptCash = function(){ /* wrapper to call module function if available */ try { window.promptCash(); } catch(e){} }
  </script>
</body>
</html>