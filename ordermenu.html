<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{
      --orange:#FFA500;--orange-2:#FFB84D;--blue:#0047AB;--blue-2:#0066CC;--white:#FFFFFF;--glass:rgba(255,255,255,0.95)
    }
    body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,var(--orange) 0%,#fff 60%,var(--blue));color:#002366;margin:0;padding:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:transparent;gap:10px}
    .btn-nav{padding:8px 14px;border:none;border-radius:10px;background:var(--glass);color:#002366;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.06);transition:transform .15s}
    .btn-nav:hover{transform:translateY(-2px)}
    h1{text-align:center;margin:8px 0 12px;font-size:1.5rem;color:#002366}
    .container{display:flex;gap:12px;padding:12px;align-items:flex-start}
    /* order summary */
    .order-summary{width:360px;background:var(--glass);border-radius:16px;padding:18px;margin-right:8px;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.1);border:1px solid rgba(0,0,0,0.05)}
    .order-summary h3{margin-top:0}
    .order-item{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:4px 0;background:white;border-radius:8px}
    .big-total{font-weight:800;text-align:center;margin:12px 0;font-size:1.25rem;color:#002366}
    .btn-full{display:block;width:100%;padding:12px;border-radius:10px;border:none;font-weight:700;margin:8px 0;cursor:pointer}
    .btn-orange{background:linear-gradient(90deg,var(--orange),var(--orange-2));color:#002366}
    .btn-green{background:#4CAF50;color:white}
    .btn-blue{background:#0057b8;color:white}
    .btn-red{background:#f44336;color:white}
    /* menu grid */
    .menu-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:18px;align-items:start;padding-bottom:80px}
    .menu-card{background:#fff;border-radius:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.08);padding:16px;cursor:pointer;transition:transform .14s}
    .menu-card:hover{transform:translateY(-6px)}
    .menu-image{width:120px;height:120px;border-radius:8px;margin:0 auto 10px;object-fit:cover;display:block}
    .cart-button{position:fixed;bottom:18px;right:18px;background:linear-gradient(90deg,#0047AB,#0066CC);color:white;border-radius:50px;padding:12px 18px;font-size:1.1rem;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1100;cursor:pointer;border:none}
    .cart-button span{background:#FF4500;border-radius:12px;padding:2px 6px;font-size:.9rem;margin-left:8px}
    /* popup / overlays */
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;z-index:999}
    .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,0.2);z-index:1000;width:360px;text-align:center;display:none}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .keypad button{padding:14px;font-size:1.1rem;border-radius:10px;border:none;background-color:var(--orange);color:white;font-weight:700;cursor:pointer;transition:transform .12s}
    .keypad button:hover{background-color:var(--orange-2);transform:scale(1.03)}
    /* receipt popup */
    #receiptPopup{width:360px;max-height:90vh;overflow:auto}
    #receiptPopup h2{color:#0047AB}
    /* mobile behavior: make order-summary as full-screen modal */
    @media (max-width:768px){
      .container{flex-direction:column;padding:10px}
      .order-summary{position:fixed;top:0;left:0;right:0;width:100%;height:100%;z-index:1200;border-radius:0;box-shadow:none;padding:18px;display:none;overflow:auto}
      .menu-grid{margin-top:12px}
      .menu-card{padding:20px}
      .menu-image{width:160px;height:160px}
      .cart-button{right:14px;bottom:14px}
    }
    /* print hide buttons */
    @media print{
      .btn-full,.cart-button,.btn-nav{display:none}
    }
  </style>
</head>
<body>
  <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>

  <header>
    <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
    <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
  </header>

  <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>

  <div class="container">
    <div class="order-summary" id="orderSummary">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
      <div id="orderMeta" style="font-size:0.95rem;color:#0047AB;margin-bottom:8px"></div>

      <div id="orderItems">
        <p style="text-align:center;color:#666;">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>
      </div>

      <div class="big-total" id="totals">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: 0 ‡∏ø</div>

      <button class="btn-full btn-orange" onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button class="btn-full btn-green" onclick="playClick(); payCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      <button class="btn-full btn-blue" onclick="playClick(); payQR()">üì± QR Code</button>
      <button class="btn-full btn-red" onclick="playClick(); cancelOrder()">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>

      <div style="margin-top:10px; display:flex; gap:8px; flex-direction:column;">
        <button class="btn-full" style="background:linear-gradient(90deg,#FFD27F,#FFB84D);color:#002366;font-weight:700" onclick="playClick(); promptDiscount()">üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
        <button class="btn-full" style="background:#999;color:white" onclick="playClick(); removeDiscount()">üßπ ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
      </div>
    </div>

    <div class="menu-grid" id="menuGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</div>
  </div>

  <button class="cart-button" id="cartButton" onclick="showCart()" style="display:none;">
    üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <span id="cartCount">0</span>
  </button>

  <!-- cash popup -->
  <div class="popup" id="cashPopup">
    <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
    <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount">0</span> ‡∏ø</strong></p>
    <input type="text" id="cashInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" readonly style="width:90%;padding:10px;border-radius:8px;border:1px solid #ccc;text-align:center;font-size:1.1rem">
    <div class="keypad" style="margin-top:12px">
      <button onclick="appendCash('1')">1</button><button onclick="appendCash('2')">2</button><button onclick="appendCash('3')">3</button>
      <button onclick="appendCash('4')">4</button><button onclick="appendCash('5')">5</button><button onclick="appendCash('6')">6</button>
      <button onclick="appendCash('7')">7</button><button onclick="appendCash('8')">8</button><button onclick="appendCash('9')">9</button>
      <button onclick="clearCash()">C</button><button onclick="appendCash('0')">0</button><button onclick="confirmCash()">‚úÖ</button>
    </div>
    <p id="changeDisplay" style="margin-top:10px;font-weight:700;color:#4CAF50"></p>
  </div>

  <!-- QR popup -->
  <div class="popup" id="qrPopup">
    <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <div id="qrContainer" style="margin:8px auto 12px; width:180px; height:180px; background:#eee; display:flex; align-items:center; justify-content:center; border-radius:10px; color:#777">QR</div>
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount">0</span> ‡∏ø</strong></p>
    <button onclick="confirmQR()" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:700;margin-top:10px">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
  </div>

  <!-- discount picker -->
  <div class="popup" id="discountPopup" style="width:320px">
    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
    <div style="display:flex;gap:8px;justify-content:center;flex-wrap:wrap;margin-top:8px">
      <button class="key" style="padding:8px 12px;border-radius:8px" onclick="selectDiscount(5)">5%</button>
      <button class="key" style="padding:8px 12px;border-radius:8px" onclick="selectDiscount(10)">10%</button>
      <button class="key" style="padding:8px 12px;border-radius:8px" onclick="selectDiscount(15)">15%</button>
      <button class="key" style="padding:8px 12px;border-radius:8px" onclick="selectDiscount(20)">20%</button>
    </div>
    <p style="margin-top:10px;font-size:0.9rem;color:#666">‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏à‡∏∞‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</p>
  </div>

  <!-- auth PIN popup -->
  <div class="popup" id="authPopup" style="width:320px">
    <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
    <input id="pinInput" type="password" maxlength="6" readonly style="width:90%;padding:10px;border-radius:8px;border:1px solid #ccc;text-align:center;font-size:1.2rem">
    <div class="keypad" style="margin-top:10px">
      <button onclick="appendPin('1')">1</button><button onclick="appendPin('2')">2</button><button onclick="appendPin('3')">3</button>
      <button onclick="appendPin('4')">4</button><button onclick="appendPin('5')">5</button><button onclick="appendPin('6')">6</button>
      <button onclick="appendPin('7')">7</button><button onclick="appendPin('8')">8</button><button onclick="appendPin('9')">9</button>
      <button onclick="clearPin()">C</button><button onclick="appendPin('0')">0</button><button onclick="submitPin()">‚úÖ</button>
    </div>
  </div>

  <!-- receipt popup -->
  <div class="popup" id="receiptPopup" style="width:420px; text-align:left;">
    <div style="text-align:center;margin-bottom:6px">
      <img src="" id="receiptLogo" style="max-width:120px; display:none"/>
    </div>
    <h2 style="text-align:center">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h2>
    <div id="receiptDetails" style="font-size:0.95rem"></div>
    <div style="display:flex;gap:8px;margin-top:10px">
      <button onclick="printReceipt()" style="flex:1;padding:10px;border-radius:8px;border:none;background:linear-gradient(90deg,#4CAF50,#45A049);color:white;font-weight:700">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå</button>
      <button onclick="closeReceipt()" style="flex:1;padding:10px;border-radius:8px;border:none;background:#999;color:white;font-weight:700">‡∏õ‡∏¥‡∏î</button>
    </div>
  </div>

  <!-- audio fallback -->
  <audio id="clickSound" src="click.mp3" preload="auto"></audio>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

    // ----------------------
    // CONFIG - set these
    // ----------------------
    const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co"; // <-- your URL
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso"; // <-- your anon key
    const ADMIN_PIN = "1234"; // <-- change to your manager PIN for discounts

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const menuGrid = document.getElementById("menuGrid");
    const overlay = document.getElementById("overlay");

    // In-memory order: { id: {id, name, price, quantity} }
    window.order = {};
    window.discountPercent = 0; // selected discount percent (0-100)

    // --- SOUND: try to play click.mp3, fallback to WebAudio beep ---
    function playBeep() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'sine';
        o.frequency.value = 800;
        g.gain.value = 0.02;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(() => { o.stop(); ctx.close(); }, 70);
      } catch (e) { /* ignore */ }
    }
    function playClick() {
      const s = document.getElementById("clickSound");
      if (s) {
        s.currentTime = 0;
        s.play().catch(() => playBeep());
      } else playBeep();
    }

    // ------------- MENU LOAD -------------
    async function loadMenu(){
      menuGrid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...";
      try {
        const { data, error } = await supabase
          .from('menu')
          .select('id,name,price,category,image,available')
          .eq('available', true)
          .order('id', { ascending: true });

        if (error) {
          console.error('Supabase error:', error);
          menuGrid.innerHTML = "<p style='color:red;text-align:center'>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß</p>";
          return;
        }

        if (!data || data.length === 0) {
          menuGrid.innerHTML = "<p style='text-align:center;color:#002366;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>";
          return;
        }

        // build cards: show image only when item.image exists
        menuGrid.innerHTML = data.map(item => {
          const imgHtml = item.image ? `<img class="menu-image" src="${item.image}" alt="${escapeHtml(item.name)}" onerror="this.style.display='none'">` : '';
          return `
            <div class="menu-card" role="button" onclick="addToCart(${item.id}, ${JSON.stringify(item.name)}, ${Number(item.price)})">
              ${imgHtml}
              <h3 style="margin:8px 0 6px">${escapeHtml(item.name)}</h3>
              <div style="color:#777">${escapeHtml(item.category || '')}</div>
              <div style="margin-top:8px;font-weight:700;color:#0047AB">${Number(item.price)} ‡∏ø</div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('Error:', err);
        menuGrid.innerHTML = "<p style='color:red;text-align:center'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î</p>";
      }
    }

    // ------------------ CART FUNCTIONS -------------------
    window.addToCart = function(id, name, price) {
      playClick();
      if (!window.order[id]) {
        window.order[id] = { id, name, price, quantity: 0 };
      }
      window.order[id].quantity++;
      updateCart();
    };

    window.increaseQty = function(id) {
      playClick();
      if (window.order[id]) {
        window.order[id].quantity++;
        updateCart();
      }
    };

    window.decreaseQty = function(id) {
      playClick();
      if (window.order[id]) {
        window.order[id].quantity--;
        if (window.order[id].quantity <= 0) delete window.order[id];
        updateCart();
      }
    };

    window.removeItem = function(id) {
      playClick();
      if (window.order[id]) {
        delete window.order[id];
        updateCart();
      }
    };

    window.updateCart = function() {
      const orderItemsEl = document.getElementById('orderItems');
      const items = Object.values(window.order);
      if (items.length === 0) {
        orderItemsEl.innerHTML = "<p style='text-align:center;color:#666;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>";
        document.getElementById('cartButton').style.display = 'none';
        document.getElementById('orderSummary').style.display = (window.innerWidth > 768 ? 'block' : 'none');
      } else {
        document.getElementById('cartButton').style.display = 'block';
        orderItemsEl.innerHTML = items.map(it => `
          <div class="order-item">
            <div style="flex:1">
              <div style="font-weight:700">${escapeHtml(it.name)}</div>
              <div style="font-size:0.85rem;color:#666">${it.price} ‡∏ø x ${it.quantity}</div>
            </div>
            <div style="display:flex;gap:6px;align-items:center">
              <button onclick="decreaseQty(${it.id})" style="background:#ffb84d;border:none;border-radius:6px;padding:6px 8px;cursor:pointer">‚àí</button>
              <div style="min-width:26px;text-align:center">${it.quantity}</div>
              <button onclick="increaseQty(${it.id})" style="background:#ffb84d;border:none;border-radius:6px;padding:6px 8px;cursor:pointer">+</button>
              <button onclick="removeItem(${it.id})" style="background:#f44336;border:none;border-radius:6px;padding:6px 8px;cursor:pointer;color:white;margin-left:6px">üóë</button>
            </div>
          </div>
        `).join('');
      }

      // totals
      const subtotal = items.reduce((s,i) => s + i.price * i.quantity, 0);
      const discountAmt = Math.round(subtotal * (window.discountPercent / 100) * 100) / 100;
      const netBeforeTax = Math.round((subtotal - discountAmt) * 100) / 100;
      const tax = Math.round(netBeforeTax * 0.07 * 100) / 100;
      const total = Math.round((netBeforeTax + tax) * 100) / 100;

      const totalsEl = document.getElementById('totals');
      totalsEl.innerHTML = `
        ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏°: ${subtotal} ‡∏ø<br>
        ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${window.discountPercent}%): ${discountAmt.toFixed(2)} ‡∏ø<br>
        ‡∏£‡∏≤‡∏Ñ‡∏≤ (‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ): ${netBeforeTax.toFixed(2)} ‡∏ø<br>
        ‡∏†‡∏≤‡∏©‡∏µ 7%: ${tax.toFixed(2)} ‡∏ø<br>
        <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${total.toFixed(2)} ‡∏ø</strong>
      `;

      // update cartCount
      const totalQty = items.reduce((s,i)=> s + i.quantity, 0);
      document.getElementById('cartCount').innerText = totalQty;
    };

    // show cart (desktop: show panel; mobile: show full screen popup)
    window.showCart = function() {
      playClick();
      if (Object.values(window.order).length === 0) {
        alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤');
        return;
      }
      const orderSummary = document.getElementById('orderSummary');
      if (window.innerWidth <= 768) {
        // mobile - full screen modal
        orderSummary.style.display = 'block';
        overlay.style.display = 'block';
      } else {
        // desktop - ensure visible as panel
        orderSummary.style.display = 'block';
      }
    };

    window.closeCart = function() {
      playClick();
      const orderSummary = document.getElementById('orderSummary');
      if (window.innerWidth <= 768) {
        orderSummary.style.display = 'none';
        overlay.style.display = 'none';
      } else {
        orderSummary.style.display = 'block'; // panel stays visible on desktop
      }
    };

    // ---------------- PAYMENT & RECEIPT ----------------
    function showPopup(id) {
      playClick();
      document.getElementById('overlay').style.display = 'block';
      document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
      const el = document.getElementById(id);
      if (el) el.style.display = 'block';
    }
    function closeAllPopups() {
      document.getElementById('overlay').style.display = 'none';
      document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
    }

    window.payCash = function() {
      const totals = computeTotals();
      document.getElementById('cashAmount').innerText = totals.total.toFixed(2);
      document.getElementById('cashInput').value = '';
      document.getElementById('changeDisplay').innerText = '';
      showPopup('cashPopup');
    };

    window.appendCash = function(v) {
      const el = document.getElementById('cashInput');
      el.value = (el.value || '') + v;
    };
    window.clearCash = function() {
      document.getElementById('cashInput').value = '';
      document.getElementById('changeDisplay').innerText = '';
    };

    window.confirmCash = async function() {
      const paid = Number(document.getElementById('cashInput').value || 0);
      const totals = computeTotals();
      if (paid < totals.total) {
        alert('‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞');
        return;
      }
      const change = Math.round((paid - totals.total) * 100) / 100;
      document.getElementById('changeDisplay').innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change.toFixed(2)} ‡∏ø`;
      // finalize: save receipt
      await finalizeOrder('cash');
      setTimeout(()=>{ closeAllPopups(); alert('üíµ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!'); window.order = {}; updateCart(); }, 900);
    };

    window.payQR = function() {
      const totals = computeTotals();
      document.getElementById('qrAmount').innerText = totals.total.toFixed(2);
      // In real system show QR image - here use placeholder box
      document.getElementById('qrContainer').innerHTML = '<div style="font-size:24px;color:#333">QR</div>';
      showPopup('qrPopup');
    };

    window.confirmQR = async function() {
      // simulate payment success
      await finalizeOrder('qr');
      closeAllPopups();
      alert('üì± ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô QR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!');
      window.order = {};
      updateCart();
    };

    // compute totals helper
    function computeTotals() {
      const items = Object.values(window.order);
      const subtotal = items.reduce((s,i) => s + i.price * i.quantity, 0);
      const discountAmt = Math.round(subtotal * (window.discountPercent / 100) * 100) / 100;
      const netBeforeTax = Math.round((subtotal - discountAmt) * 100) / 100;
      const tax = Math.round(netBeforeTax * 0.07 * 100) / 100;
      const total = Math.round((netBeforeTax + tax) * 100) / 100;
      return { subtotal, discountAmt, netBeforeTax, tax, total };
    }

    // Save receipt + receipt items to Supabase
    async function finalizeOrder(paymentMethod='unknown') {
      const items = Object.values(window.order);
      if (items.length === 0) return;
      const totals = computeTotals();

      try {
        // insert receipt
        const { data: rdata, error: rerr } = await supabase
          .from('receipts')
          .insert([{
            total: totals.total,
            subtotal: totals.subtotal,
            discount_percent: window.discountPercent,
            discount_amount: totals.discountAmt,
            tax: totals.tax,
            payment_method: paymentMethod,
            created_at: new Date().toISOString()
          }])
          .select('id')
          .single();

        if (rerr) { console.error('Receipt insert error', rerr); return; }
        const receipt_id = rdata.id;

        // insert receipt_items (batch)
        const itemsToInsert = items.map(it => ({
          receipt_id,
          menu_id: it.id,
          name: it.name,
          price: it.price,
          quantity: it.quantity,
          total: it.price * it.quantity
        }));

        const { error: ierr } = await supabase.from('receipt_items').insert(itemsToInsert);
        if (ierr) { console.error('receipt_items insert error', ierr); }

        // show printable receipt popup
        showReceiptPopup(receipt_id, itemsToInsert, totals, paymentMethod);
      } catch (e) {
        console.error('finalizeOrder error', e);
      }
    }

    // receipt popup rendering
    function showReceiptPopup(receipt_id, items, totals, paymentMethod){
      const details = document.getElementById('receiptDetails');
      let html = `<div><strong>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏¥‡∏•:</strong> ${receipt_id || '-'}<br><strong>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà:</strong> ${new Date().toLocaleString()}</div><hr>`;
      html += '<div>';
      items.forEach(it=>{
        html += `<div style="display:flex;justify-content:space-between;margin:6px 0"><div>${escapeHtml(it.name)} x ${it.quantity}</div><div>${(it.total).toFixed(2)} ‡∏ø</div></div>`;
      });
      html += '</div><hr>';
      html += `<div>‡∏£‡∏ß‡∏°: ${totals.subtotal.toFixed(2)} ‡∏ø<br>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${totals.discountAmt ? totals.discountAmt.toFixed(2) + ' ‡∏ø' : '0.00 ‡∏ø'}<br>‡∏†‡∏≤‡∏©‡∏µ 7%: ${totals.tax.toFixed(2)} ‡∏ø<br><strong>‡∏£‡∏ß‡∏°‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${totals.total.toFixed(2)} ‡∏ø</strong><br>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢: ${escapeHtml(paymentMethod)}</div>`;
      details.innerHTML = html;
      showPopup('receiptPopup');
    }

    function printReceipt(){
      window.print();
    }
    function closeReceipt(){
      closeAllPopups();
    }

    // ---------------- DISCOUNT & AUTH ----------------
    function promptDiscount(){
      showPopup('discountPopup');
    }
    let pendingDiscount = 0;
    function selectDiscount(pct){
      pendingDiscount = pct;
      closeAllPopups();
      // show auth PIN
      showPopup('authPopup');
      document.getElementById('pinInput').value = '';
    }
    function appendPin(v){ document.getElementById('pinInput').value += v; }
    function clearPin(){ document.getElementById('pinInput').value = ''; }
    function submitPin(){
      const pin = document.getElementById('pinInput').value;
      if (pin === ADMIN_PIN) {
        window.discountPercent = pendingDiscount;
        updateCart();
        closeAllPopups();
        alert(`‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î ${pendingDiscount}% ‡πÅ‡∏•‡πâ‡∏ß`);
      } else {
        alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
      }
    }
    function removeDiscount(){
      window.discountPercent = 0;
      updateCart();
      alert('‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î‡πÅ‡∏•‡πâ‡∏ß');
    }

    // ---------------- ORDER CANCEL ----------------
    function cancelOrder(){
      if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')) {
        window.order = {};
        window.discountPercent = 0;
        updateCart();
        closeCart();
      }
    }

    // ----------------- NAV -----------------
    function goHome(){ window.location.href = 'index.html'; }
    function goBack(){ window.history.back(); }

    // ----------------- helpers -----------------
    function escapeHtml(text){ if(!text) return ''; return String(text).replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

    // ----------------- INITIALIZE -----------------
    loadMenu();
    updateCart();

    // handle overlay click to close popups and on mobile hide orderSummary
    overlay.addEventListener('click', ()=>{
      closeAllPopups();
      if (window.innerWidth <= 768) {
        // hide mobile order panel if visible
        const orderSummary = document.getElementById('orderSummary');
        orderSummary.style.display = 'none';
      }
    });

    // keep orderSummary as panel on desktop by default
    if (window.innerWidth > 768) {
      document.getElementById('orderSummary').style.display = 'block';
    }

  </script>

</body>
</html>