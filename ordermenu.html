<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root {
            --orange: #FFA500;
            --orange-2: #FFB84D;
            --blue: #0047AB;
            --blue-2: #0066CC;
            --white: #FFFFFF;
            --glass: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, var(--orange) 0%, #ffffff 60%, var(--blue));
            color: #002366;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            background: transparent;
            gap: 10px;
        }

        .btn-nav {
            padding: 8px 14px;
            border: none;
            border-radius: 10px;
            background: var(--glass);
            color: #002366;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
            transition: transform .15s ease;
        }

        .btn-nav:hover {
            transform: translateY(-2px);
        }

        h1 {
            text-align: center;
            margin: 8px 0 12px;
            font-size: 1.5rem;
            color: #002366;
        }

        .container {
            display: flex;
            gap: 12px;
            padding: 12px;
            align-items: flex-start;
        }

        .order-summary {
            width: 320px;
            background: var(--glass);
            border-radius: 16px;
            padding: 14px;
            margin-right: 8px;
            min-width: 260px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .order-summary h3 {
            text-align: center;
            margin-top: 0;
            color: #002366;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }

        .order-item .controls button {
            font-size: 0.95rem;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--orange);
            color: white;
            cursor: pointer;
            font-weight: 700;
            transition: transform .12s ease;
        }

        .order-item .controls button:hover {
            transform: scale(1.1);
            background: var(--orange-2);
        }

        .summary-total {
            margin-top: 12px;
            font-weight: 700;
            color: #002366;
            line-height: 1.4;
            text-align: center;
        }

        .menu-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
            align-items: start;
        }

        .menu-item {
            background: #ffffff;
            border-radius: 14px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            padding: 12px;
            cursor: pointer;
            transition: transform .14s ease;
        }

        .menu-item:hover {
            transform: translateY(-6px);
        }

        .image-placeholder {
            width: 100%;
            height: 110px;
            background: #eee;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-summary button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            margin-top: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }

        .order-summary button:first-of-type {
            background: linear-gradient(90deg, var(--blue), var(--blue-2));
            color: white;
        }

        .order-summary button:nth-of-type(2) {
            background: linear-gradient(90deg, var(--orange), var(--orange-2));
            color: #002366;
        }

        .order-summary button:nth-of-type(3) {
            background: linear-gradient(90deg, #FF6347, #FF4500);
            color: white;
        }

        .order-summary button:nth-of-type(4) {
            background: linear-gradient(90deg, #999, #666);
            color: white;
        }

        .order-summary button:hover {
            transform: scale(1.05);
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 340px;
            text-align: center;
            display: none;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            z-index: 999;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .keypad button {
            padding: 14px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: none;
            background-color: var(--orange);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform .12s ease;
        }

        .keypad button:hover {
            background-color: var(--orange-2);
            transform: scale(1.05);
        }

        .popup input {
            padding: 10px;
            width: 90%;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            text-align: center;
            font-size: 1.2rem;
        }

        .payment-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
        }

        .payment-buttons button {
            flex: 1;
            background: linear-gradient(90deg, #FFD27F, #FFB84D) !important;
            color: #002366 !important;
            font-weight: 700 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 10px 0 !important;
            font-size: 1rem !important;
            cursor: pointer !important;
            transition: transform .15s ease, background .2s !important;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .payment-buttons button:hover {
            transform: scale(1.05);
            background: linear-gradient(90deg, #FFC04D, #FFA500) !important;
        }

        #qrPopup img {
            display: block;
            margin: 10px auto;
            max-width: 75%;
            height: auto;
        }

        /* ‚úÖ CSS ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏°‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (QR) */
        #qrPopup button {
            background: linear-gradient(90deg, #4CAF50, #45A049) !important;
            color: white !important;
            font-weight: 700 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 10px 0 !important;
            font-size: 1rem !important;
            cursor: pointer !important;
            transition: transform .15s ease, background .2s !important;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            width: 90%;
            margin-top: 15px;
        }

        #qrPopup button:hover {
            transform: scale(1.05);
            background: linear-gradient(90deg, #45A049, #388E3C) !important;
        }


        #receiptPopup {
            width: 320px !important;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 20px;
        }

        #receiptPopup h2 {
            color: #0047AB;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        #receiptPopup .receipt-actions {
            display: flex;
            justify-content: space-between;
            gap: 12px;
            margin-top: 10px;
        }

        #receiptPopup .receipt-actions button {
            flex: 1;
            display: inline-block;
            border-radius: 10px;
            padding: 10px 0;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: transform 0.2s ease;
            margin: 0;
        }

        #receiptPopup .receipt-actions button:first-of-type {
            background: linear-gradient(90deg, #4CAF50, #45A049);
            color: white;
        }

        #receiptPopup .receipt-actions button:nth-of-type(2) {
            background: linear-gradient(90deg, #999, #777);
            color: white;
        }

        #receiptPopup .receipt-actions button:hover {
            transform: scale(1.05);
        }

        .receipt-header img {
            width: 80px !important;
            height: auto;
            margin-bottom: 6px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        @media print {
            #receiptPopup .receipt-actions button {
                display: none !important;
            }

            #receiptPopup {
                width: 100% !important;
                box-shadow: none !important;
            }
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .receipt-table th,
        .receipt-table td {
            border-bottom: 1px dashed rgba(0, 0, 0, 0.15);
            padding: 6px 8px;
            font-size: 0.95rem;
        }


        .discount-btn {
            background: linear-gradient(90deg, #FFA500, #FFB84D);
            color: #002366;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .discount-clear-btn {
            margin-top: 16px;
            background: linear-gradient(90deg, #999, #666);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .order-summary {
                position: sticky;
                top: 0;
                width: 100%;
                z-index: 1000;
                margin: 0 0 10px 0;
                border-radius: 0 0 16px 16px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .menu-item {
                padding: 8px;
                border-radius: 12px;
                font-size: 0.9rem;
            }

            .image-placeholder {
                height: 80px;
                font-size: 0.8rem;
            }
        }


        .cart-button {
            position: fixed;
            bottom: 18px;
            right: 18px;
            background: linear-gradient(90deg, #0047AB, #0066CC);
            color: white;
            border-radius: 50px;
            padding: 12px 18px;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            cursor: pointer;
            transition: transform .15s ease;
        }

        .cart-button span {
            background: #FF4500;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 0.9rem;
            margin-left: 4px;
        }
    </style>

</head>

<body onload="loadMenu()">
    <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>
    <header>
        <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
        <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
    </header>
    <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>

    <div class="container">
        <div class="order-summary" id="orderSummary" style="display:none;">
            <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            <div id="orderInfo" style="text-align:center; margin-bottom:8px; font-weight:600; color:#0047AB;"></div>
            <div id="orderItems"></div>
            <div class="summary-total" id="totalSummary"></div>
            <button onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            <button onclick="playClick(); promptDiscountAuth()">üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
            <button onclick="playClick(); submitOrder()">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button onclick="playClick(); cancelOrder()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="playClick(); removeDiscount()">üßπ ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
        </div>
        <div class="menu-grid" id="menuGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</div>
    </div>

    <div class="popup" id="discountPopup">
        <h3 style="color:#0047AB; margin-bottom:14px;">üéÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
        <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
            <button class="discount-btn" onclick="playClick(); applyDiscount(5)">5%</button>
            <button class="discount-btn" onclick="playClick(); applyDiscount(10)">10%</button>
            <button class="discount-btn" onclick="playClick(); applyDiscount(15)">15%</button>
            <button class="discount-btn" onclick="playClick(); applyDiscount(20)">20%</button>
        </div>
        <button class="discount-clear-btn" onclick="playClick(); removeDiscount()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
    </div>

    <div class="popup" id="authPopup">
        <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
        <input id="pinInput" type="password" maxlength="6" readonly>
        <div class="keypad">
            <button onclick="playClick(); appendPin('1')">1</button>
            <button onclick="playClick(); appendPin('2')">2</button>
            <button onclick="playClick(); appendPin('3')">3</button>
            <button onclick="playClick(); appendPin('4')">4</button>
            <button onclick="playClick(); appendPin('5')">5</button>
            <button onclick="playClick(); appendPin('6')">6</button>
            <button onclick="playClick(); appendPin('7')">7</button>
            <button onclick="playClick(); appendPin('8')">8</button>
            <button onclick="playClick(); appendPin('9')">9</button>
            <button onclick="playClick(); clearPin()">C</button>
            <button onclick="playClick(); appendPin('0')">0</button>
            <button onclick="playClick(); submitPin()">‚úÖ</button>
        </div>
    </div>

    <div class="popup" id="cashPopup">
        <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
        <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount"></span> ‡∏ø</strong></p>
        <input type="text" id="cashInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" readonly />

        <div class="keypad">
            <button onclick="playClick(); appendCash('1')">1</button>
            <button onclick="playClick(); appendCash('2')">2</button>
            <button onclick="playClick(); appendCash('3')">3</button>
            <button onclick="playClick(); appendCash('4')">4</button>
            <button onclick="playClick(); appendCash('5')">5</button>
            <button onclick="playClick(); appendCash('6')">6</button>
            <button onclick="playClick(); appendCash('7')">7</button>
            <button onclick="playClick(); appendCash('8')">8</button>
            <button onclick="playClick(); appendCash('9')">9</button>
            <button onclick="playClick(); clearCash()">C</button>
            <button onclick="playClick(); appendCash('0')">0</button>
            <button onclick="playClick(); confirmCash()">‚úÖ</button>
        </div>
        <p id="changeDisplay" style="margin-top:8px;font-weight:600;"></p>
    </div>

    <div class="popup" id="qrPopup">
        <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <img id="qrImage" src="kshop.jpg" alt="QR Code">
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount"></span> ‡∏ø</strong></p>
        <button onclick="playClick(); confirmQR()">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à</button>
    </div>

    <div class="popup" id="paymentPopup">
        <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <div class="payment-buttons">
            <button onclick="playClick(); payCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
            <button onclick="playClick(); payQR()">üì± QR Code</button>
        </div>
    </div>

    <div class="popup" id="receiptPopup" style="width:360px;text-align:left;">
        <div class="receipt-header">
            <img src="logo.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏™‡∏µ‡πà‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß">
            <h3 style="text-align:center;">‡∏ä‡∏≤‡∏¢‡∏™‡∏µ‡πà‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß ‡∏Å‡∏≠‡∏•‡πå‡∏ü‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà</h3>
            <h5 style="text-align:center;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà 95/7 ‡∏°.7 ‡∏ï.‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà ‡∏à.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô 40110</h5>
            <h5 style="text-align:center;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:1409700103387</h5>
            <h5 style="text-align:center;">‡πÇ‡∏ó‡∏£.082-3804188</h5>
        </div>
        <h4 style="text-align:center;">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠/üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4>
        <div id="receiptDetails"></div>
        <h5 style="text-align:center;">‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô</h5>
        <div class="receipt-actions">
            <button onclick="playClick(); window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
            <button onclick="playClick(); closeReceipt()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
        </div>
    </div>

    <div id="cartButton" class="cart-button" onclick="showCart()">
        üõí <span id="cartCount">0</span>
    </div>

    <script>
        // ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL/KEY ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso";

        const { createClient } = window.supabase;
        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

        let order = {};
        let discountPercent = 0;
        let menuMap = {};

        // ------------------ Menu Loading Logic ----------------
        async function loadMenu() {
            try {
                const menuGrid = document.getElementById("menuGrid");
                menuGrid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...";

                const { data, error } = await supabase
                    .from("menu")
                    .select("id,name,price,category,image,available")
                    .eq("available", true)
                    .order("id", { ascending: true });

                if (error) {
                    console.error("Supabase Error (Menu Load):", error.message);
                    menuGrid.innerHTML = `<p style='color:red;text-align:center;'>‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏î‡∏∂‡∏á‡πÄ‡∏°‡∏ô‡∏π: ${error.message} (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö URL/KEY ‡∏´‡∏£‡∏∑‡∏≠ RLS Policy ‡∏ï‡∏≤‡∏£‡∏≤‡∏á menu: SELECT)</p>`;
                    return;
                }

                if (!data || data.length === 0) {
                    menuGrid.innerHTML = "<p style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà 'available'</p>";
                    return;
                }

                // **üõë ‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á menuMap: ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏±‡πà‡∏ô‡πÉ‡∏à‡∏ß‡πà‡∏≤‡πÄ‡∏Å‡πá‡∏ö id ‡πÑ‡∏ß‡πâ**
                data.forEach(item => {
                    menuMap[item.name] = { id: item.id, price: item.price };
                });
                
                // **‚úÖ DEBUG: ‡πÅ‡∏™‡∏î‡∏á menuMap ‡πÉ‡∏ô Console ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö**
                console.log("MenuMap ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:", menuMap);

                menuGrid.innerHTML = data.map(item => {
                    const imageUrl = item.image || 'kshop.jpg';

                    // ‡πÉ‡∏ä‡πâ item.name ‡∏ó‡∏µ‡πà‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏™‡∏£‡πâ‡∏≤‡∏á HTML (escape single quotes)
                    const cleanName = item.name.replace(/'/g, "\\'"); 

                    return `
                        <div class="menu-item" onclick="playClick(); addToOrder({ name: '${cleanName}', price: ${item.price} })">
                            <div class="image-placeholder">
                                <img src="${imageUrl}" alt="${item.name}" onerror="this.src='kshop.jpg'">
                            </div>
                            <h3 style="margin:8px 0;font-size:1.1rem;">${item.name}</h3>
                            <strong style="color:#0047AB;font-size:1.1rem;">${item.price} ‡∏ø</strong>
                        </div>
                    `;
                }).join("");
            } catch (err) {
                console.error("Error loading menu:", err);
                document.getElementById("menuGrid").innerHTML = `<p style='color:red;text-align:center;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π: ${err.message}</p>`;
            }
        }

        // ------------------ Navigation / Sound / Popups ----------------

        function goHome() {
            window.location.href = 'index.html';
        }

        function goBack() {
            window.history.back();
        }

        let audioCtx;

        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }

        function playClick() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = "square";
            osc.frequency.value = 550;
            gain.gain.value = 0.08;
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
            if (navigator.vibrate) navigator.vibrate(40);
        }

        function playError() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = "sawtooth";
            osc.frequency.value = 180;
            gain.gain.value = 0.12;
            osc.start();
            osc.stop(audioCtx.currentTime + 0.25);
            if (navigator.vibrate) navigator.vibrate([100, 60, 100]);
        }
        const _alert = window.alert;
        window.alert = function (msg) {
            playError();
            _alert(msg);
        };
        document.addEventListener("DOMContentLoaded", loadOrderInfo);
        document.addEventListener("click", () => {
            try {
                if (typeof audioCtx !== "undefined" && audioCtx.state === "suspended") {
                    audioCtx.resume();
                } else if (typeof initAudio === "function" && (!audioCtx || audioCtx.state !== "running")) {
                    initAudio();
                }
            } catch (e) {}
        }, {
            once: true
        });


        // ------------------ Popup Control ----------------
        function showPopup(id) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById(id).style.display = 'block';
        }

        function closeAllPopups() {
            document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
            document.getElementById('overlay').style.display = 'none';
        }

        function closeCart() {
            document.getElementById('orderSummary').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }

        function closeReceipt() {
            closeAllPopups();
        }


        // ------------------ Cart/Order Logic ----------------
        function loadOrderInfo() {
            const orderType = localStorage.getItem("orderType") || "-";
            const customerCount = localStorage.getItem("customerCount") || "-";
            const tableNumber = localStorage.getItem("tableNumber") || "N/A"; 
            const text = `üçΩÔ∏è ${orderType} | üë• ${customerCount} ‡∏Ñ‡∏ô | ü™ë ‡πÇ‡∏ï‡πä‡∏∞ ${tableNumber}`;
            const el = document.getElementById("orderInfo");
            if (el) el.innerHTML = text;
        }

        function updateCartCount() {
            const count = Object.values(order).reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').innerText = count;
            document.getElementById('cartButton').style.display = count > 0 ? 'flex' : 'none';
        }

        function addToOrder(item) {
            const n = item.name,
                p = Number(item.price);
            
            // **üõë ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö menu_id ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î**
            const menuInfo = menuMap[n];
            if (!menuInfo || typeof menuInfo.id === 'undefined' || menuInfo.id === null) {
                alert(`‚ùå ‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏´‡∏±‡∏™ ID ‡∏Ç‡∏≠‡∏á‡πÄ‡∏°‡∏ô‡∏π "${n}" ‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö (menuMap ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?)`); 
                console.error("‡πÄ‡∏°‡∏ô‡∏π ID ‡∏´‡∏≤‡∏¢:", n, menuMap);
                return;
            }

            if (!order[n]) order[n] = {
                price: p,
                quantity: 1,
                menu_id: menuInfo.id // ‡πÉ‡∏ä‡πâ ID ‡∏ó‡∏µ‡πà‡πÑ‡∏î‡πâ‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            };
            else order[n].quantity++;
            updateSummary();
            updateCartCount();
        }

        function changeQty(n, c) {
            if (order[n]) {
                order[n].quantity += c;
                if (order[n].quantity <= 0) delete order[n];
                updateSummary();
                updateCartCount();
            }
        }

        function removeItem(n) {
            delete order[n];
            updateSummary();
            updateCartCount();
        }

        function calcTaxFromIncluded(totalWithVat) {
            totalWithVat = Number(totalWithVat) || 0; 
            const beforeVat = totalWithVat / 1.07;
            const vatAmount = totalWithVat - beforeVat;
            return {
                beforeVat,
                vatAmount
            };
        }

        function updateSummary() {
            const items = document.getElementById('orderItems'),
                t = document.getElementById('totalSummary');

            items.innerHTML = '';
            let subtotal = 0;
            for (const n in order) {
                const it = order[n];
                subtotal += it.price * it.quantity;
                items.innerHTML += `
            <div class='order-item'>
                <div>${n}</div>
                <div class='controls'>
                    <button onclick="playClick(); changeQty('${n}',-1)">-</button>
                    <span>${it.quantity}</span>
                    <button onclick="playClick(); changeQty('${n}',1)">+</button>
                    <button onclick="playClick(); removeItem('${n}')">üóëÔ∏è</button>
                </div>
            </div>`;
            }

            const discount = subtotal * (discountPercent / 100);
            const totalAfterDiscount = subtotal - discount;
            const {
                beforeVat,
                vatAmount
            } = calcTaxFromIncluded(totalAfterDiscount);
            const net = totalAfterDiscount;

            t.innerHTML = `
            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ): ${subtotal.toFixed(2)} ‡∏ø<br>
            ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${discountPercent}%): ${discount.toFixed(2)} ‡∏ø<br>
            ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ: ${beforeVat.toFixed(2)} ‡∏ø<br>
            ‡∏†‡∏≤‡∏©‡∏µ (7%): ${vatAmount.toFixed(2)} ‡∏ø<br>
            <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ): ${net.toFixed(2)} ‡∏ø</strong>
            `;
        }

        function getTotal() {
            let subtotal = Object.values(order).reduce((s, i) => s + i.price * i.quantity, 0);
            const discount = subtotal * (discountPercent / 100);
            return Math.max(0, subtotal - discount); 
        }

        function submitOrder() {
            if (Object.keys(order).length === 0) {
                alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
                return;
            }
            if (getTotal() <= 0) {
                 alert('‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏õ‡πá‡∏ô 0 ‡∏´‡∏£‡∏∑‡∏≠‡∏ï‡∏¥‡∏î‡∏•‡∏ö ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î');
                 return;
            }
            showPopup('paymentPopup');
        }

        function cancelOrder() {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠?')) {
                order = {};
                discountPercent = 0;
                updateSummary();
                updateCartCount();
                closeAllPopups();
            }
        }

        function promptDiscountAuth() {
            showPopup('authPopup');
        }

        function submitPin() {
            const pin = document.getElementById('pinInput').value;
            // ‚ö†Ô∏è HARDCODED PIN - ‡∏Ñ‡∏ß‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏≠‡∏ô‡∏≤‡∏Ñ‡∏ï
            if (pin === '000000') { 
                closeAllPopups();
                showPopup('discountPopup');
                clearPin();
            } else {
                alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                clearPin();
            }
        }

        function applyDiscount(p) {
            discountPercent = p;
            closeAllPopups();
            updateSummary();
            updateCartCount();
        }

        function removeDiscount() {
            discountPercent = 0;
            closeAllPopups();
            updateSummary();
            updateCartCount();
        }

        function appendPin(num) {
            const input = document.getElementById('pinInput');
            if (input.value.length < 6) input.value += num;
        }

        function clearPin() {
            document.getElementById('pinInput').value = '';
        }

        function payCash() {
            closeAllPopups();
            const t = getTotal();
            document.getElementById('cashAmount').innerText = t.toFixed(2);
            showPopup('cashPopup');
            clearCash();
        }

        function payQR() {
            closeAllPopups();
            const t = getTotal();
            document.getElementById('qrAmount').innerText = t.toFixed(2);
            showPopup('qrPopup');
        }

        function appendCash(num) {
            const input = document.getElementById('cashInput');
            input.value += num;
        }

        function clearCash() {
            document.getElementById('cashInput').value = '';
            document.getElementById('changeDisplay').innerText = '';
        }

        // üöÄ ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç order_type, table_number, total_amount, ‡πÅ‡∏•‡∏∞ menu_id ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏±‡∏î‡∏Å‡∏∏‡∏°)
        async function saveOrderToSupabase(method) {
            // 1. ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
            const subtotal = Object.values(order).reduce((s, i) => s + i.price * i.quantity, 0);
            const discount = subtotal * (discountPercent / 100);
            
            const total = Math.max(0, subtotal - discount); 
            
            if (total <= 0) {
                throw new Error("Invalid total amount (<= 0). Cannot save order."); 
            }
            
            const {
                beforeVat,
                vatAmount
            } = calcTaxFromIncluded(total); 

            // üõë ‡∏Å‡∏≤‡∏£‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Ñ‡πà‡∏≤ NULL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö NOT NULL Columns üõë
            const tableNumber = localStorage.getItem("tableNumber") || 'N/A'; 
            const orderType = localStorage.getItem("orderType") || 'Takeaway'; 
            const customerCount = parseInt(localStorage.getItem("customerCount")) || 1; 

            // 2.1. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á receipts ‡∏Å‡πà‡∏≠‡∏ô 
            const receiptData = {
                store_name : storename,
                store_address : storeaddress,
                store_tax_id : storetaxid,
                store_phone : storephone,
                table_number: tableNumber,
                order_type: orderType, 
                people_count: customerCount, 
                discount_percent: discountPercent,
                subtotal: subtotal,
                discount_amount: discount,
                total_before_tax: beforeVat,
                tax_amount: vatAmount,
                total_amount: total, 
                payment_method: method
            };

            const {
                data: receipt,
                error: receiptError
            } = await supabase
                .from('receipts')
                .insert([receiptData])
                .select('id') 
                .single();

            if (receiptError) {
                console.error("Supabase Receipt INSERT Error:", receiptError);
                alert(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Error: ${receiptError.message}). ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Console (F12)`);
                throw receiptError;
            }

            // 2.2. ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á receipt_items
            const receiptId = receipt.id;
            const itemsToInsert = Object.keys(order).map(itemName => {
                const item = order[itemName];
                
                // **üõë ‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏î‡∏∂‡∏á menu_id ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏£‡∏≠‡∏ö‡∏Ñ‡∏≠‡∏ö**
                const menuInfo = menuMap[itemName];
                const finalMenuId = (menuInfo && typeof menuInfo.id !== 'undefined' && menuInfo.id !== null) ? menuInfo.id : item.menu_id;

                if (typeof finalMenuId === 'undefined' || finalMenuId === null) {
                     console.error(`‚ùå ‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£: ${itemName} ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÑ‡∏°‡πà‡∏û‡∏ö menu_id ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á (menuMap ‡∏´‡∏£‡∏∑‡∏≠ order object ‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤?)`);
                     // **‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç:** ‡∏´‡∏≤‡∏Å‡∏´‡∏≤ ID ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡πâ‡∏≤‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÑ‡∏õ
                     return null; 
                }

                return {
                    receipt_id: receiptId,
                    menu_id: finalMenuId, // ‡πÉ‡∏ä‡πâ‡∏Ñ‡πà‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
                    item_name: itemName,
                    price_per_unit: item.price,
                    quantity: item.quantity,
                    total_price: item.price * item.quantity
                };
            }).filter(item => item !== null); // ‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô null ‡∏≠‡∏≠‡∏Å‡πÑ‡∏õ

            // **üõë ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏£‡∏ì‡∏µ itemsToInsert ‡πÄ‡∏õ‡πá‡∏ô‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏á**
            if (itemsToInsert.length === 0) {
                 console.warn("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏´‡πâ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô receipt_items! (‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à...)");
                 // ‚ö†Ô∏è ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢
                 await supabase.from('receipts').delete().eq('id', receiptId);
                 throw new Error("‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏ô‡∏∑‡πà‡∏≠‡∏á‡∏à‡∏≤‡∏Å‡∏Ç‡∏≤‡∏î menu_id");
            }

            const {
                error: itemsError
            } = await supabase
                .from('receipt_items')
                .insert(itemsToInsert);

            if (itemsError) {
                console.error("Supabase Item INSERT Error:", itemsError);
                // ‚ö†Ô∏è ‡∏´‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡∏ö‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏¥‡πâ‡∏á‡∏î‡πâ‡∏ß‡∏¢
                await supabase.from('receipts').delete().eq('id', receiptId); 
                alert(`‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! (Error: ${itemsError.message}). ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏ñ‡∏π‡∏Å‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å.`);
                throw itemsError;
            }

            return receiptId;
        }


        async function confirmCash() {
            const paid = Number(document.getElementById('cashInput').value || 0);
            const t = getTotal(); 

            if (paid < t) return alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            const change = paid - t;

            try {
                // **üõë ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤ menuMap ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ alert**
                 if (Object.keys(menuMap).length === 0) {
                     throw new Error("‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà.");
                 }

                await saveOrderToSupabase('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î'); 
                document.getElementById('changeDisplay').innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change.toFixed(2)} ‡∏ø`;
                setTimeout(() => showReceipt('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', paid, change), 800);
            } catch (err) {
                console.error("Supabase INSERT Error:", err);
                document.getElementById('changeDisplay').innerText = `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`;
            }
        }

        async function confirmQR() {
            try {
                 // **üõë ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö: ‡∏ñ‡πâ‡∏≤ menuMap ‡∏¢‡∏±‡∏á‡∏ß‡πà‡∏≤‡∏á‡∏≠‡∏¢‡∏π‡πà ‡πÉ‡∏´‡πâ alert**
                 if (Object.keys(menuMap).length === 0) {
                     throw new Error("‡πÄ‡∏°‡∏ô‡∏π‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î. ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏µ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà.");
                 }

                await saveOrderToSupabase('QR Code'); 
                showReceipt('QR Code', getTotal(), 0);
            } catch (err) {
                console.error("Supabase INSERT Error:", err);
                // alert ‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ô saveOrderToSupabase ‡πÅ‡∏•‡πâ‡∏ß
            }
        }

        function showReceipt(method, paid, change) {
            const orderType = localStorage.getItem("orderType") || "Takeaway";
            const customerCount = localStorage.getItem("customerCount") || "1";
            const tableNumber = localStorage.getItem("tableNumber") || "N/A";
            closeAllPopups();

            let html = `
            <div style="margin-bottom:10px; font-weight:600;">
                üçΩÔ∏è ${orderType} | üë• ${customerCount} ‡∏Ñ‡∏ô | ü™ë ‡πÇ‡∏ï‡πä‡∏∞ ${tableNumber}
            </div>
            <table class="receipt-table">
                <tr>
                    <th style="width:60%; text-align:left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th style="width:20%; text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th style="width:20%; text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                </tr>`;

            let subtotal = 0,
                totalQty = 0;
            for (const n in order) {
                const it = order[n];
                subtotal += it.price * it.quantity;
                totalQty += it.quantity;
                html += `
                <tr>
                    <td>${n}</td>
                    <td style="text-align:center;">${it.quantity}</td>
                    <td style="text-align:right;">${(it.price * it.quantity).toFixed(2)}</td>
                </tr>`;
            }

            const discount = subtotal * (discountPercent / 100);
            const totalAfterDiscount = subtotal - discount;
            const {
                beforeVat,
                vatAmount
            } = calcTaxFromIncluded(totalAfterDiscount);
            const net = totalAfterDiscount;

            html += `
            <tr>
                <td colspan="3" style="text-align:left; font-weight:bold;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
            </tr>
            </table>

            <div style="display:flex; justify-content:space-between; margin-top:10px; border-top: 1px dashed rgba(0, 0, 0, 0.15); padding-top: 10px;">
                <div style="text-align:left; font-size:0.9rem;">
                    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${method}<br>
                    ${method === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' ? `‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏≤: ${paid.toFixed(2)} ‡∏ø<br>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change.toFixed(2)} ‡∏ø<br>` : ''}
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleString('th-TH')}
                </div>
                <div style="text-align:right; font-size:0.9rem;">
                    ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ): ${subtotal.toFixed(2)} ‡∏ø<br>
                    ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${discountPercent}%): ${discount.toFixed(2)} ‡∏ø<br>
                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ: ${beforeVat.toFixed(2)} ‡∏ø<br>
                    ‡∏†‡∏≤‡∏©‡∏µ (7%): ${vatAmount.toFixed(2)} ‡∏ø<br>
                    <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${net.toFixed(2)} ‡∏ø</strong>
                </div>
            </div>`;

            document.getElementById('receiptDetails').innerHTML = html;
            showPopup('receiptPopup');

            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            order = {};
            discountPercent = 0;
            updateSummary();
            updateCartCount();
        }

        function showCart() {
            if (Object.keys(order).length === 0) return alert("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
            showPopup('orderSummary');
            updateSummary();
        }
    </script>
</body>
</html>
