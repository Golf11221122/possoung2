<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--orange:#FFA500;--orange-2:#FFB84D;--blue:#0047AB;--blue-2:#0066CC;--white:#FFFFFF;--glass:rgba(255,255,255,0.9)}
    body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,var(--orange) 0%,#fff 60%,var(--blue));color:#002366;margin:0;padding:0;-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:transparent;gap:10px}
    .btn-nav{padding:8px 14px;border:none;border-radius:10px;background:var(--glass);color:#002366;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.06);transition:transform .15s}
    .btn-nav:hover{transform:translateY(-2px)}
    h1{text-align:center;margin:8px 0 12px;font-size:1.5rem;color:#002366}
    .container{display:flex;gap:12px;padding:12px;align-items:flex-start}
    .order-summary{width:320px;background:var(--glass);border-radius:16px;padding:14px;margin-right:8px;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.1);border:1px solid rgba(0,0,0,0.05)}
    .order-summary h3{text-align:center;margin-top:0;color:#002366}
    .order-item{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;gap:8px}
    .order-item .controls button{font-size:.95rem;width:32px;height:32px;border:none;border-radius:8px;background:var(--orange);color:white;cursor:pointer;font-weight:700;transition:transform .12s}
    .order-item .controls button:hover{transform:scale(1.1);background:var(--orange-2)}
    .summary-total{margin-top:12px;font-weight:700;color:#002366;line-height:1.4;text-align:center}
    .menu-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;align-items:start}
    .menu-item{background:#fff;border-radius:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.08);padding:12px;cursor:pointer;transition:transform .14s}
    .menu-item:hover{transform:translateY(-6px)}
    .image-placeholder{width:100%;height:110px;background:#eee;border-radius:10px;display:flex;align-items:center;justify-content:center;color:#666;font-size:.95rem;margin-bottom:10px}
    .order-summary button{width:100%;padding:10px;border:none;border-radius:12px;font-weight:700;margin-top:8px;cursor:pointer;font-size:1rem;transition:.2s}
    .order-summary button:first-of-type{background:linear-gradient(90deg,var(--blue),var(--blue-2));color:white}
    .order-summary button:nth-of-type(2){background:linear-gradient(90deg,var(--orange),var(--orange-2));color:#002366}
    .order-summary button:nth-of-type(3){background:linear-gradient(90deg,#FF6347,#FF4500);color:white}
    .order-summary button:nth-of-type(4){background:linear-gradient(90deg,#999,#666);color:white}
    .order-summary button:hover{transform:scale(1.05)}
    .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,0.2);z-index:1000;width:340px;text-align:center;display:none}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;z-index:999}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .keypad button{padding:14px;font-size:1.2rem;border-radius:10px;border:none;background-color:var(--orange);color:white;font-weight:600;cursor:pointer;transition:transform .12s}
    .keypad button:hover{background-color:var(--orange-2);transform:scale(1.05)}
    .popup input{padding:10px;width:90%;border-radius:8px;border:1px solid rgba(0,0,0,0.08);text-align:center;font-size:1.2rem}
    .payment-buttons{display:flex;justify-content:center;gap:12px;margin-top:10px}
    .payment-buttons button{flex:1;background:linear-gradient(90deg,#FFD27F,#FFB84D)!important;color:#002366!important;font-weight:700!important;border:none!important;border-radius:12px!important;padding:10px 0!important;font-size:1rem!important;cursor:pointer!important;transition:transform .15s ease,background .2s!important;box-shadow:0 3px 10px rgba(0,0,0,0.1)}
    .payment-buttons button:hover{transform:scale(1.05);background:linear-gradient(90deg,#FFC04D,#FFA500)!important}
    #receiptPopup{width:320px!important;max-height:90vh;overflow-y:auto}
    #qrPopup img{width:180px!important;height:auto;margin:0 auto;display:block;border-radius:8px}
    #receiptPopup{background:#fff;border:1px solid #ccc}
    #qrPopup{width:320px;text-align:center;border-radius:16px;background:#fff;padding:20px;box-shadow:0 10px 30px rgba(0,0,0,0.15)}
    #qrPopup h3{margin-bottom:10px;color:#0047AB}
    #qrPopup img{width:180px;height:auto;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1);margin-bottom:10px}
    #qrPopup button{background:linear-gradient(90deg,#4CAF50,#45A049);color:white;font-weight:600;border:none;border-radius:10px;padding:10px 16px;cursor:pointer;transition:transform .2s}
    #qrPopup button:hover{transform:scale(1.05)}
    @media (max-width:768px){.container{flex-direction:column}.order-summary{position:sticky;top:0;width:100%;z-index:1000;margin:0 0 10px 0;border-radius:0 0 16px 16px;box-shadow:0 4px 12px rgba(0,0,0,0.15)}.menu-grid{grid-template-columns:repeat(2,1fr);gap:10px}.menu-item{padding:8px;border-radius:12px;font-size:.9rem}.image-placeholder{height:80px;font-size:.8rem}}
    .cart-button{position:fixed;bottom:18px;right:18px;background:linear-gradient(90deg,#0047AB,#0066CC);color:white;border-radius:50px;padding:12px 18px;font-size:1.1rem;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1100;cursor:pointer;transition:transform .15s}
    .cart-button:hover{transform:scale(1.05)}
    .cart-button span{background:#FF4500;border-radius:12px;padding:2px 6px;font-size:.9rem;margin-left:4px}
  </style>
</head>
<body>
  <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>

  <header>
    <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
    <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
  </header>

  <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>

  <div class="container">
    <div class="order-summary" id="orderSummary" style="display:none;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
      <div id="orderInfo" style="text-align:center;margin-bottom:8px;font-weight:600;color:#0047AB;"></div>
      <div id="orderItems"></div>
      <div class="summary-total" id="totalSummary"></div>
      <button onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button onclick="playClick(); promptDiscountAuth()">üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
      <button onclick="playClick(); openPaymentPopup()">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
      <button onclick="playClick(); cancelOrder()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
      <button onclick="playClick(); removeDiscount()">üßπ ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
    </div>

    <div class="menu-grid" id="menuGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</div>
  </div>

  <!-- popups -->
  <div class="popup" id="discountPopup">
    <h3 style="color:#0047AB;margin-bottom:14px;">üéÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
    <div style="display:flex;justify-content:center;gap:12px;flex-wrap:wrap;">
      <button class="discount-btn" onclick="playClick(); applyDiscount(5)">5%</button>
      <button class="discount-btn" onclick="playClick(); applyDiscount(10)">10%</button>
      <button class="discount-btn" onclick="playClick(); applyDiscount(15)">15%</button>
      <button class="discount-btn" onclick="playClick(); applyDiscount(20)">20%</button>
    </div>
    <button class="discount-clear-btn" onclick="playClick(); removeDiscount()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
  </div>

  <div class="popup" id="authPopup">
    <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
    <input id="pinInput" type="password" maxlength="6" readonly>
    <div class="keypad">
      <button onclick="playClick(); appendPin('1')">1</button>
      <button onclick="playClick(); appendPin('2')">2</button>
      <button onclick="playClick(); appendPin('3')">3</button>
      <button onclick="playClick(); appendPin('4')">4</button>
      <button onclick="playClick(); appendPin('5')">5</button>
      <button onclick="playClick(); appendPin('6')">6</button>
      <button onclick="playClick(); appendPin('7')">7</button>
      <button onclick="playClick(); appendPin('8')">8</button>
      <button onclick="playClick(); appendPin('9')">9</button>
      <button onclick="playClick(); clearPin()">C</button>
      <button onclick="playClick(); appendPin('0')">0</button>
      <button onclick="playClick(); submitPin()">‚úÖ</button>
    </div>
  </div>

  <div class="popup" id="cashPopup">
    <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
    <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount"></span> ‡∏ø</strong></p>
    <input type="text" id="cashInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" />
    <div class="keypad">
      <button onclick="playClick(); appendCash('1')">1</button>
      <button onclick="playClick(); appendCash('2')">2</button>
      <button onclick="playClick(); appendCash('3')">3</button>
      <button onclick="playClick(); appendCash('4')">4</button>
      <button onclick="playClick(); appendCash('5')">5</button>
      <button onclick="playClick(); appendCash('6')">6</button>
      <button onclick="playClick(); appendCash('7')">7</button>
      <button onclick="playClick(); appendCash('8')">8</button>
      <button onclick="playClick(); appendCash('9')">9</button>
      <button onclick="playClick(); clearCash()">C</button>
      <button onclick="playClick(); appendCash('0')">0</button>
      <button onclick="playClick(); confirmCash()">‚úÖ</button>
    </div>
    <p id="changeDisplay" style="margin-top:8px;font-weight:600;"></p>
  </div>

  <div class="popup" id="qrPopup">
    <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <img id="qrImage" src="kshop.jpg" alt="QR Code">
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount"></span> ‡∏ø</strong></p>
    <button onclick="playClick(); confirmQR()">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
  </div>

  <div class="popup" id="paymentPopup">
    <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <div class="payment-buttons">
      <button onclick="playClick(); payCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      <button onclick="playClick(); payQR()">üì± QR Code</button>
    </div>
  </div>

  <div class="popup" id="receiptPopup" style="width:360px;text-align:left;">
    <div class="receipt-header">
      <img src="logo.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏™‡∏µ‡πà‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß" style="width:80px">
      <h3 style="text-align:center;">‡∏ä‡∏≤‡∏¢‡∏™‡∏µ‡πà‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß ‡∏Å‡∏≠‡∏•‡πå‡∏ü‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà</h3>
      <h5 style="text-align:center;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà 95/7 ‡∏°.7 ‡∏ï.‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà ‡∏à.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô 40110</h5>
      <h5 style="text-align:center;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:1409700103387</h5>
      <h5 style="text-align:center;">‡πÇ‡∏ó‡∏£.082-3804188</h5>
    </div>
    <h4 style="text-align:center;">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠/üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4>
    <div id="receiptDetails"></div>
    <h5 style="text-align:center;">‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô</h5>
    <button onclick="playClick(); window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
    <button onclick="playClick(); closeReceipt()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
  </div>

  <button class="cart-button" id="cartBtn" onclick="openCart()">üõí <span id="cartCount">0</span></button>

  <!-- Supabase + Main script -->
  <script type="module">
    // ------------------ IMPORTANT ------------------
    // ‡πÉ‡∏™‡πà‡∏Ñ‡πà‡∏≤ Supabase ‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà (ANON key)
    const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso";
    // -----------------------------------------------

    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    // WebAudio click sound (no external file)
    function playClick() {
      try {
        const ctx = new (window.AudioContext || window.webkitAudioContext)();
        const o = ctx.createOscillator();
        const g = ctx.createGain();
        o.type = 'square';
        o.frequency.value = 800;
        g.gain.value = 0.02;
        o.connect(g);
        g.connect(ctx.destination);
        o.start();
        setTimeout(()=> { o.stop(); ctx.close(); }, 60);
      } catch(e){ /* ignore on old browsers */ }
    }

    /* ================== App state ================== */
    let order = {}; // { itemId: { id, name, price, quantity } }
    let discountPercent = 0;

    // load/save cart + discount to localStorage
    function loadCartFromStorage(){
      try {
        const raw = localStorage.getItem('cart');
        const d = localStorage.getItem('discountPercent');
        if(raw) order = JSON.parse(raw); else order = {};
        discountPercent = d ? Number(d) : 0;
      } catch(e){ order = {}; discountPercent = 0; }
      updateCartUI();
    }
    function saveCartToStorage(){
      localStorage.setItem('cart', JSON.stringify(order));
      localStorage.setItem('discountPercent', String(discountPercent));
      updateCartUI();
    }

    /* ============ Menu Loading (Supabase) ============ */
    const menuGrid = document.getElementById('menuGrid');
    async function loadMenu() {
      menuGrid.innerHTML = '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...';
      try {
        // ‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏Ñ‡∏∏‡∏ì‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå available ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ .eq('available', true)
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ ‡πÉ‡∏´‡πâ‡∏•‡∏ö .eq(...) ‡∏≠‡∏≠‡∏Å
        const { data, error } = await supabase
          .from('menu')
          .select('id,name,price,category,image,available')
          .eq('available', true)
          .order('id', { ascending: true });

        if (error) throw error;
        if (!data || data.length === 0) {
          menuGrid.innerHTML = '<p>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>';
          return;
        }

        menuGrid.innerHTML = data.map(item => {
          const img = item.image && item.image.trim() !== '' ? item.image : 'kshop.jpg';
          // escape name displayed inside HTML
          return `
            <div class="menu-item" data-id="${item.id}" onclick="addToCart(${item.id}, ${JSON.stringify(item.name)}, ${item.price})">
              <div class="image-placeholder">
                <img src="${img}" alt="${escapeHtml(item.name)}" style="width:100%;height:100%;object-fit:cover;border-radius:8px" onerror="this.src='kshop.jpg'">
              </div>
              <div class="menu-info">
                <h3 style="margin:6px 0 4px">${escapeHtml(item.name)}</h3>
                <p style="margin:0 0 6px">${escapeHtml(item.category || '')}</p>
                <strong>${item.price} ‡∏ö‡∏≤‡∏ó</strong>
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        console.error('loadMenu error', err);
        menuGrid.innerHTML = '<p style="color:red;">‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π</p>';
      }
    }

    function escapeHtml(str){
      if(!str) return '';
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');
    }

    /* ============ Cart functions ============ */
    window.addToCart = function(id, name, price) {
      const key = String(id);
      if (!order[key]) order[key] = { id, name, price, quantity: 0 };
      order[key].quantity += 1;
      saveCartToStorage();
      openCart();
      playClick();
    }

    function updateCartUI(){
      const orderItemsEl = document.getElementById('orderItems');
      const totalSummaryEl = document.getElementById('totalSummary');
      const cartCountEl = document.getElementById('cartCount');
      const orderInfoEl = document.getElementById('orderInfo');

      const items = Object.values(order);
      if(items.length === 0){
        orderItemsEl.innerHTML = '<p style="text-align:center;color:#666">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤</p>';
        totalSummaryEl.innerText = '';
        cartCountEl.innerText = '0';
        document.getElementById('orderSummary').style.display = 'none';
        return;
      }

      document.getElementById('orderSummary').style.display = 'block';
      cartCountEl.innerText = items.reduce((s,i)=> s + i.quantity, 0);

      orderItemsEl.innerHTML = items.map(it => `
        <div class="order-item">
          <div style="flex:1">
            <div style="font-weight:700">${escapeHtml(it.name)}</div>
            <div style="color:#555">${it.price} ‡∏ø x ${it.quantity}</div>
          </div>
          <div class="controls" style="display:flex;flex-direction:column;gap:6px">
            <button onclick="decreaseQty(${it.id})">-</button>
            <button onclick="increaseQty(${it.id})">+</button>
            <button onclick="removeItem(${it.id})" style="background:#FF4D4D;width:36px;height:28px;border-radius:6px;margin-top:6px">üóë</button>
          </div>
        </div>
      `).join('');

      const subtotal = items.reduce((s,i)=> s + i.price * i.quantity, 0);
      const discount = Math.round(subtotal * (discountPercent/100));
      const total = subtotal - discount;
      totalSummaryEl.innerHTML = `‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ): <strong>${total} ‡∏ø</strong><br>‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î: ${discountPercent}% (${discount} ‡∏ø)`;

      // orderInfo placeholders (you can store real values in localStorage)
      const orderType = localStorage.getItem('orderType') || '‡∏ó‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô';
      const customerCount = localStorage.getItem('customerCount') || '1';
      const tableNumber = localStorage.getItem('tableNumber') || '-';
      orderInfoEl.innerText = `${orderType} | üë• ${customerCount} ‡∏Ñ‡∏ô | ü™ë ‡πÇ‡∏ï‡πä‡∏∞: ${tableNumber}`;
    }

    window.increaseQty = function(id){ const k=String(id); if(order[k]){ order[k].quantity+=1; saveCartToStorage(); } }
    window.decreaseQty = function(id){ const k=String(id); if(order[k]){ order[k].quantity-=1; if(order[k].quantity<=0) delete order[k]; saveCartToStorage(); } }
    window.removeItem = function(id){ const k=String(id); if(order[k]){ delete order[k]; saveCartToStorage(); } }

    function openCart(){ document.getElementById('orderSummary').style.display='block'; window.scrollTo({ top:0, behavior:'smooth' }); }
    function closeCart(){ document.getElementById('orderSummary').style.display='none'; }

    /* ============ Discount / PIN ============ */
    function promptDiscountAuth(){ showPopup('authPopup'); }
    function appendPin(d){ const el=document.getElementById('pinInput'); el.value=(el.value + d).slice(0,6); }
    function clearPin(){ document.getElementById('pinInput').value=''; }
    function submitPin(){ const val=document.getElementById('pinInput').value; closeAllPopups(); if(val === '1234'){ showPopup('discountPopup'); } else { alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); } document.getElementById('pinInput').value=''; }
    function applyDiscount(p){ discountPercent = p; saveCartToStorage(); closeAllPopups(); updateCartUI(); }
    function removeDiscount(){ discountPercent = 0; saveCartToStorage(); updateCartUI(); }

    /* ============ Cash keypad ============ */
    function appendCash(d){ const el=document.getElementById('cashInput'); el.value = (el.value + d).replace(/^0+/, ''); }
    function clearCash(){ document.getElementById('cashInput').value = ''; }
    function payCash(){
      const subtotal = Object.values(order).reduce((s,i)=> s + i.price*i.quantity, 0);
      const discount = Math.round(subtotal * (discountPercent/100));
      const total = subtotal - discount;
      document.getElementById('cashAmount').innerText = total;
      showPopup('cashPopup');
    }
    function confirmCash(){
      const paid = Number(document.getElementById('cashInput').value || 0);
      const subtotal = Object.values(order).reduce((s,i)=> s + i.price*i.quantity, 0);
      const discount = Math.round(subtotal * (discountPercent/100));
      const total = subtotal - discount;
      if(paid < total){ alert('‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏à‡πà‡∏≤‡∏¢‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏û‡∏≠'); return; }
      const change = paid - total;
      document.getElementById('changeDisplay').innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô ${change} ‡∏ø`;
      closeAllPopups();
      submitOrder('cash');
    }

    /* ============ QR flow ============ */
    function payQR(){
      const subtotal = Object.values(order).reduce((s,i)=> s + i.price*i.quantity, 0);
      const discount = Math.round(subtotal * (discountPercent/100));
      const total = subtotal - discount;
      document.getElementById('qrAmount').innerText = total;
      showPopup('qrPopup');
    }
    function confirmQR(){ closeAllPopups(); submitOrder('qr'); }

    function openPaymentPopup(){ showPopup('paymentPopup'); }

    /* ============ Popup control ============ */
    function showPopup(id){ document.getElementById('overlay').style.display='block'; document.getElementById(id).style.display='block'; }
    function closeAllPopups(){ document.getElementById('overlay').style.display='none'; document.querySelectorAll('.popup').forEach(p=>p.style.display='none'); }

    /* ============ Receipt & Save to Supabase ============ */
    async function submitOrder(paymentMethod = 'cash') {
      const items = Object.values(order);
      if(items.length === 0){ alert('‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á'); return; }

      // build receipt fields - adjust to match your receipts table schema
      const subtotal = items.reduce((s,i)=> s + i.price*i.quantity, 0);
      const discountAmt = Math.round(subtotal * (discountPercent/100));
      const grandTotal = subtotal - discountAmt;
      const receiptPayload = {
        order_typ: localStorage.getItem('orderType') || '‡∏ó‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏£‡πâ‡∏≤‡∏ô',
        people_cc: Number(localStorage.getItem('customerCount') || 1),
        table_num: localStorage.getItem('tableNumber') || null,
        subtotal: subtotal,
        discount: discountAmt,
        tax: 0, // ‡∏ñ‡πâ‡∏≤‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ô‡∏†‡∏≤‡∏©‡∏µ ‡πÉ‡∏´‡πâ‡πÉ‡∏™‡πà‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ
        grand_tot: grandTotal,
        payment: paymentMethod,
        created_at: new Date().toISOString()
      };

      try {
        // insert receipt
        const { data:receiptData, error:rcptErr } = await supabase
          .from('receipts')
          .insert(receiptPayload)
          .select().single();

        if (rcptErr) throw rcptErr;
        const receipt_id = receiptData.id;

        // insert items (receipt_items)
        const itemsPayload = items.map(it => ({
          receipt_id,
          item_name: it.name,
          qty: it.quantity,
          price: it.price,
          total_price: it.price * it.quantity
        }));

        const { data:itemsData, error:itemsErr } = await supabase
          .from('receipt_items')
          .insert(itemsPayload);

        if(itemsErr) throw itemsErr;

        // success - show receipt popup
        renderReceipt(receiptData, itemsPayload);
        // clear cart
        order = {};
        discountPercent = 0;
        saveCartToStorage();
        closeAllPopups();
        showPopup('receiptPopup');
      } catch (err) {
        console.error('submitOrder error', err);
        alert('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á (‡∏î‡∏π console)');
      }
    }

    function renderReceipt(receipt, itemsPayload){
      const el = document.getElementById('receiptDetails');
      const rows = itemsPayload.map(i => `<tr><td>${escapeHtml(i.item_name)}</td><td style="text-align:right">${i.qty} x ${i.price}</td><td style="text-align:right">${i.total_price} ‡∏ø</td></tr>`).join('');
      el.innerHTML = `
        <h2 style="text-align:center;color:#0047AB">‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</h2>
        <table class="receipt-table">
          <thead><tr><th>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th></th><th style="text-align:right">‡∏£‡∏ß‡∏°</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
        <p style="text-align:right;font-weight:700;margin-top:8px">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${receipt.grand_tot} ‡∏ø</p>
      `;
    }

    function closeReceipt(){ closeAllPopups(); }

    /* ============ Helpers on page load ============ */
    document.addEventListener('DOMContentLoaded', async () => {
      loadCartFromStorage();
      await loadMenu();
    });

    // expose some functions used by onclick attributes
    window.playClick = playClick;
    window.openCart = openCart;
    window.closeCart = closeCart;
    window.promptDiscountAuth = promptDiscountAuth;
    window.applyDiscount = applyDiscount;
    window.removeDiscount = removeDiscount;
    window.appendPin = appendPin;
    window.submitPin = submitPin;
    window.appendCash = appendCash;
    window.clearCash = clearCash;
    window.payCash = payCash;
    window.confirmCash = confirmCash;
    window.payQR = payQR;
    window.confirmQR = confirmQR;
    window.openPaymentPopup = openPaymentPopup;
    window.closeReceipt = closeReceipt;

    // navigation helpers (customize or remove)
    function goHome(){ window.location.href = '/'; }
    function goBack(){ window.history.back(); }
  </script>
</body>
</html>