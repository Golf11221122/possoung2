<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--orange:#FFA500;--orange-2:#FFB84D;--blue:#0047AB;--blue-2:#0066CC;--white:#FFFFFF;--glass:rgba(255,255,255,0.9)}
    body{font-family:'Prompt',sans-serif;background:linear-gradient(135deg,var(--orange) 0%,#fff 60%,var(--blue));color:#002366;margin:0;padding:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 18px;background:transparent;gap:10px}
    .btn-nav{padding:8px 14px;border:none;border-radius:10px;background:var(--glass);color:#002366;font-weight:600;cursor:pointer;box-shadow:0 4px 10px rgba(0,0,0,0.06);transition:transform .15s}
    .btn-nav:hover{transform:translateY(-2px)}
    h1{text-align:center;margin:8px 0 12px;font-size:1.5rem;color:#002366}
    .container{display:flex;gap:12px;padding:12px;align-items:flex-start}
    .order-summary{width:320px;background:var(--glass);border-radius:16px;padding:14px;margin-right:8px;min-width:260px;box-shadow:0 8px 24px rgba(0,0,0,0.1);border:1px solid rgba(0,0,0,0.05)}
    .order-summary button{width:100%;margin:6px 0;padding:10px;border:none;border-radius:8px;font-weight:600;cursor:pointer;font-size:1rem;transition:transform .15s}
    .order-summary button:hover{transform:translateY(-2px)}
    .order-summary button:nth-child(4){background:var(--orange);color:white}
    .order-summary button:nth-child(5){background:#4CAF50;color:white}
    .order-summary button:nth-child(6){background:var(--blue);color:white}
    .order-summary button:nth-child(7){background:#f44336;color:white}
    .menu-grid{flex:1;display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:14px;align-items:start}
    .menu-item{background:#fff;border-radius:14px;text-align:center;box-shadow:0 8px 20px rgba(0,0,0,0.08);padding:12px;cursor:pointer;transition:transform .14s}
    .menu-item:hover{transform:translateY(-6px)}
    .image-placeholder{width:100%;height:110px;background:#eee;border-radius:10px;overflow:hidden;margin-bottom:10px}
    .image-placeholder img{width:100%;height:100%;object-fit:cover}
    .cart-button{position:fixed;bottom:18px;right:18px;background:linear-gradient(90deg,#0047AB,#0066CC);color:white;border-radius:50px;padding:12px 18px;font-size:1.1rem;font-weight:700;box-shadow:0 4px 10px rgba(0,0,0,0.3);z-index:1100;cursor:pointer;transition:transform .15s;border:none}
    .cart-button:hover{transform:scale(1.05)}
    .cart-button span{background:#FF4500;border-radius:12px;padding:2px 6px;font-size:.9rem;margin-left:4px}
    .popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;padding:20px;border-radius:14px;box-shadow:0 20px 50px rgba(0,0,0,0.2);z-index:1000;width:340px;text-align:center;display:none}
    .overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.45);display:none;z-index:999}
    .keypad{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-top:10px}
    .keypad button{padding:14px;font-size:1.2rem;border-radius:10px;border:none;background-color:var(--orange);color:white;font-weight:600;cursor:pointer;transition:transform .12s}
    .keypad button:hover{background-color:var(--orange-2);transform:scale(1.05)}
    .popup input{padding:10px;width:90%;border-radius:8px;border:1px solid rgba(0,0,0,0.08);text-align:center;font-size:1.2rem}
    .order-item{display:flex;justify-content:space-between;align-items:center;padding:8px;margin:4px 0;background:white;border-radius:8px}
  </style>
</head>

<body>
  <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>

  <header>
    <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
    <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
  </header>

  <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>
  <div class="container">
    <div class="order-summary" id="orderSummary" style="display:none;">
      <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
      <div id="orderItems"></div>
      <div id="totalSummary" style="text-align:center;margin-top:10px;font-size:1.2rem;font-weight:700;"></div>
      <button onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
      <button onclick="playClick(); payCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
      <button onclick="playClick(); payQR()">üì± QR Code</button>
      <button onclick="playClick(); cancelOrder()">‚úñ ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
    </div>
    <div class="menu-grid" id="menuGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</div>
  </div>

  <button class="cart-button" id="cartButton" onclick="showCart()" style="display:none;">
    üõí ‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤ <span id="cartCount">0</span>
  </button>

  <div class="popup" id="cashPopup">
    <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
    <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount"></span> ‡∏ø</strong></p>
    <input type="text" id="cashInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" readonly />
    <div class="keypad">
      <button onclick="appendCash('1')">1</button><button onclick="appendCash('2')">2</button><button onclick="appendCash('3')">3</button>
      <button onclick="appendCash('4')">4</button><button onclick="appendCash('5')">5</button><button onclick="appendCash('6')">6</button>
      <button onclick="appendCash('7')">7</button><button onclick="appendCash('8')">8</button><button onclick="appendCash('9')">9</button>
      <button onclick="clearCash()">C</button><button onclick="appendCash('0')">0</button>
      <button onclick="confirmCash()">‚úÖ</button>
    </div>
    <p id="changeDisplay" style="margin-top:8px;font-weight:600;color:#4CAF50;"></p>
  </div>

  <div class="popup" id="qrPopup">
    <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
    <img id="qrImage" src="kshop.jpg" alt="QR Code" style="width:180px;border-radius:10px;">
    <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount"></span> ‡∏ø</strong></p>
    <button onclick="confirmQR()" style="width:100%;padding:12px;background:#4CAF50;color:white;border:none;border-radius:8px;font-weight:600;cursor:pointer;margin-top:10px">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
  </div>

  <audio id="clickSound" src="click.mp3" preload="auto"></audio>

  <script type="module">
    import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";
    
    const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
    const menuGrid = document.getElementById("menuGrid");
    
    // Make order global
    window.order = {};

    async function loadMenu() {
      try {
        menuGrid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...";
        
        // ‡∏•‡∏≠‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠ debug
        const { data, error } = await supabase
          .from("menu")
          .select("id,name,price,category,image,available")
          .order("id", { ascending: true });

        console.log("All data:", data); // ‡∏î‡∏π‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        console.log("Error:", error);

        if (error) {
          console.error("‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß:", error);
          menuGrid.innerHTML = `<p style='color:red;text-align:center;'>‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${error.message}</p>`;
          return;
        }

        if (!data || data.length === 0) {
          menuGrid.innerHTML = "<p style='text-align:center;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á menu</p>";
          return;
        }

        // ‡∏Å‡∏£‡∏≠‡∏á‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏ó‡∏µ‡πà available = true
        const availableItems = data.filter(item => item.available === true);
        console.log("Available items:", availableItems);

        if (availableItems.length === 0) {
          menuGrid.innerHTML = `<p style='text-align:center;'>‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π‡∏ó‡∏µ‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏Ç‡∏≤‡∏¢<br><small>‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${data.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</small></p>`;
          return;
        }

        menuGrid.innerHTML = availableItems.map(item => `
          <div class="menu-item" onclick="window.addToCart('${item.id}','${item.name.replace(/'/g, "\\'")}',${item.price})">
            <div class="image-placeholder">
              <img src="${item.image || 'kshop.jpg'}" alt="${item.name}" onerror="this.src='kshop.jpg'">
            </div>
            <h3 style="margin:8px 0;font-size:1.1rem;">${item.name}</h3>
            <p style="color:#666;font-size:0.9rem;margin:4px 0;">${item.category || ""}</p>
            <strong style="color:#0047AB;font-size:1.1rem;">${item.price} ‡∏ø</strong>
          </div>
        `).join("");
        
      } catch (err) {
        console.error("Error loading menu:", err);
        menuGrid.innerHTML = "<p style='color:red;text-align:center;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà</p>";
      }
    }

    // Make functions global
    window.addToCart = function(id, name, price) {
      playClick();
      if (!window.order[id]) {
        window.order[id] = { id, name, price, quantity: 0 };
      }
      window.order[id].quantity++;
      updateCart();
    }

    window.updateCart = function() {
      const items = Object.values(window.order);
      const total = items.reduce((s, i) => s + i.price * i.quantity, 0);
      const totalQty = items.reduce((s, i) => s + i.quantity, 0);
      
      if (totalQty > 0) {
        document.getElementById("cartButton").style.display = "block";
        document.getElementById("cartCount").innerText = totalQty;
      } else {
        document.getElementById("cartButton").style.display = "none";
        document.getElementById("orderSummary").style.display = "none";
      }
      
      if (items.length > 0) {
        document.getElementById("orderItems").innerHTML = items.map(it => `
          <div class="order-item">
            <span>${it.name} x ${it.quantity}</span>
            <strong>${it.price * it.quantity} ‡∏ø</strong>
          </div>
        `).join("");
        document.getElementById("totalSummary").innerHTML = `‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${total} ‡∏ø`;
      }
    }

    window.showCart = function() {
      const items = Object.values(window.order);
      if (items.length === 0) {
        alert("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
        return;
      }
      document.getElementById("orderSummary").style.display = "block";
    }

    window.payCash = function() {
      const total = Object.values(window.order).reduce((s, i) => s + i.price * i.quantity, 0);
      document.getElementById("cashAmount").innerText = total;
      document.getElementById("cashInput").value = "";
      document.getElementById("changeDisplay").innerText = "";
      showPopup("cashPopup");
    }

    window.confirmCash = function() {
      const paid = Number(document.getElementById("cashInput").value || 0);
      const total = Object.values(window.order).reduce((s, i) => s + i.price * i.quantity, 0);
      
      if (paid < total) {
        alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ó‡πà‡∏≤‡∏Å‡∏±‡∏ö‡∏¢‡∏≠‡∏î‡∏ä‡∏≥‡∏£‡∏∞");
        return;
      }
      
      const change = paid - total;
      document.getElementById("changeDisplay").innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change} ‡∏ø`;
      
      setTimeout(() => {
        closeAllPopups();
        alert("üíµ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
        window.order = {};
        updateCart();
      }, 1500);
    }

    window.payQR = function() {
      const total = Object.values(window.order).reduce((s, i) => s + i.price * i.quantity, 0);
      document.getElementById("qrAmount").innerText = total;
      showPopup("qrPopup");
    }

    window.confirmQR = function() {
      closeAllPopups();
      alert("üì± ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡∏ú‡πà‡∏≤‡∏ô QR ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!");
      window.order = {};
      updateCart();
    }

    // Load menu on page load
    loadMenu();
  </script>

  <script>
    function playClick() {
      try {
        const s = document.getElementById("clickSound");
        s.currentTime = 0;
        s.play().catch(e => console.log("Audio play failed:", e));
      } catch (e) {
        // Ignore audio errors
      }
    }
    
    function goHome() {
      window.location.href = "index.html";
    }
    
    function goBack() {
      window.history.back();
    }
    
    function showPopup(id) {
      document.getElementById("overlay").style.display = "block";
      document.getElementById(id).style.display = "block";
    }
    
    function closeAllPopups() {
      document.getElementById("overlay").style.display = "none";
      document.querySelectorAll(".popup").forEach(p => p.style.display = "none");
    }
    
    function appendCash(v) {
      const el = document.getElementById("cashInput");
      el.value += v;
    }
    
    function clearCash() {
      document.getElementById("cashInput").value = "";
      document.getElementById("changeDisplay").innerText = "";
    }
    
    function closeCart() {
      document.getElementById("orderSummary").style.display = "none";
    }
    
    function cancelOrder() {
      if (confirm("‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?")) {
        window.order = {};
        updateCart();
        closeCart();
      }
    }
  </script>
</body>
</html>