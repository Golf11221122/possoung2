<!DOCTYPE html>
<html lang="th">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</title>
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --orange: #FFA500;
            --orange-2: #FFB84D;
            --blue: #0047AB;
            --blue-2: #0066CC;
            --white: #FFFFFF;
            --glass: rgba(255, 255, 255, 0.9);
        }

        body {
            font-family: 'Prompt', sans-serif;
            background: linear-gradient(135deg, var(--orange) 0%, #ffffff 60%, var(--blue));
            color: #002366;
            margin: 0;
            padding: 0;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 18px;
            background: transparent;
            gap: 10px;
        }

        .btn-nav {
            padding: 8px 14px;
            border: none;
            border-radius: 10px;
            background: var(--glass);
            color: #002366;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.06);
            transition: transform .15s ease;
        }

        .btn-nav:hover {
            transform: translateY(-2px);
        }

        h1 {
            text-align: center;
            margin: 8px 0 12px;
            font-size: 1.5rem;
            color: #002366;
        }

        .container {
            display: flex;
            gap: 12px;
            padding: 12px;
            align-items: flex-start;
        }

        .order-summary {
            width: 320px;
            background: var(--glass);
            border-radius: 16px;
            padding: 14px;
            margin-right: 8px;
            min-width: 260px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .order-summary h3 {
            text-align: center;
            margin-top: 0;
            color: #002366;
        }

        .order-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }

        .order-item .controls button {
            font-size: 0.95rem;
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            background: var(--orange);
            color: white;
            cursor: pointer;
            font-weight: 700;
            transition: transform .12s ease;
        }

        .order-item .controls button:hover {
            transform: scale(1.1);
            background: var(--orange-2);
        }

        .summary-total {
            margin-top: 12px;
            font-weight: 700;
            color: #002366;
            line-height: 1.4;
            text-align: center;
        }

        .menu-grid {
            flex: 1;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 14px;
            align-items: start;
        }

        .menu-item {
            background: #ffffff;
            border-radius: 14px;
            text-align: center;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            padding: 12px;
            cursor: pointer;
            transition: transform .14s ease;
        }

        .menu-item:hover {
            transform: translateY(-6px);
        }

        .image-placeholder {
            width: 100%;
            height: 110px;
            background: #eee;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
            font-size: 0.95rem;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .image-placeholder img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .order-summary button {
            width: 100%;
            padding: 10px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            margin-top: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
        }

        .order-summary button:first-of-type {
            background: linear-gradient(90deg, var(--blue), var(--blue-2));
            color: white;
        }

        .order-summary button:nth-of-type(2) {
            background: linear-gradient(90deg, var(--orange), var(--orange-2));
            color: #002366;
        }

        .order-summary button:nth-of-type(3) {
            background: linear-gradient(90deg, #FF6347, #FF4500);
            color: white;
        }

        .order-summary button:nth-of-type(4) {
            background: linear-gradient(90deg, #999, #666);
            color: white;
        }

        .order-summary button:hover {
            transform: scale(1.05);
        }

        .popup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            padding: 20px;
            border-radius: 14px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            width: 340px;
            text-align: center;
            display: none;
        }

        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.45);
            display: none;
            z-index: 999;
        }

        .keypad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .keypad button {
            padding: 14px;
            font-size: 1.2rem;
            border-radius: 10px;
            border: none;
            background-color: var(--orange);
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: transform .12s ease;
        }

        .keypad button:hover {
            background-color: var(--orange-2);
            transform: scale(1.05);
        }

        .popup input {
            padding: 10px;
            width: 90%;
            border-radius: 8px;
            border: 1px solid rgba(0, 0, 0, 0.08);
            text-align: center;
            font-size: 1.2rem;
        }

        .payment-buttons {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-top: 10px;
        }

        .payment-buttons button {
            flex: 1;
            background: linear-gradient(90deg, #FFD27F, #FFB84D) !important;
            color: #002366 !important;
            font-weight: 700 !important;
            border: none !important;
            border-radius: 12px !important;
            padding: 10px 0 !important;
            font-size: 1rem !important;
            cursor: pointer !important;
            transition: transform .15s ease, background .2s !important;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .payment-buttons button:hover {
            transform: scale(1.05);
            background: linear-gradient(90deg, #FFC04D, #FFA500) !important;
        }

        #receiptPopup {
            width: 320px !important;
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 16px;
            background: #fff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            padding: 20px;
        }

        #receiptPopup h2 {
            color: #0047AB;
            font-size: 1.2rem;
            margin-bottom: 8px;
        }

        #receiptPopup button {
            display: inline-block;
            width: 48%;
            border-radius: 10px;
            padding: 10px 0;
            font-weight: 600;
            border: none;
            cursor: pointer;
            margin-top: 10px;
            transition: transform 0.2s ease;
        }

        #receiptPopup button:first-of-type {
            background: linear-gradient(90deg, #4CAF50, #45A049);
            color: white;
        }

        #receiptPopup button:nth-of-type(2) {
            background: linear-gradient(90deg, #999, #777);
            color: white;
            margin-left: 4%;
        }

        #receiptPopup button:hover {
            transform: scale(1.05);
        }

        .receipt-header img {
            width: 80px !important;
            height: auto;
            margin-bottom: 6px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        @media print {
            #receiptPopup button {
                display: none !important;
            }

            #receiptPopup {
                width: 100% !important;
                box-shadow: none !important;
            }
        }

        .receipt-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .receipt-table th,
        .receipt-table td {
            border-bottom: 1px dashed rgba(0, 0, 0, 0.15);
            padding: 6px 8px;
            font-size: 0.95rem;
        }


        .discount-btn {
            background: linear-gradient(90deg, #FFA500, #FFB84D);
            color: #002366;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1.1rem;
            transition: all 0.2s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }

        .discount-clear-btn {
            margin-top: 16px;
            background: linear-gradient(90deg, #999, #666);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.2s ease;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }

            .order-summary {
                position: sticky;
                top: 0;
                width: 100%;
                z-index: 1000;
                margin: 0 0 10px 0;
                border-radius: 0 0 16px 16px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            }

            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            .menu-item {
                padding: 8px;
                border-radius: 12px;
                font-size: 0.9rem;
            }

            .image-placeholder {
                height: 80px;
                font-size: 0.8rem;
            }
        }


        .cart-button {
            position: fixed;
            bottom: 18px;
            right: 18px;
            background: linear-gradient(90deg, #0047AB, #0066CC);
            color: white;
            border-radius: 50px;
            padding: 12px 18px;
            font-size: 1.1rem;
            font-weight: 700;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            z-index: 1100;
            cursor: pointer;
            transition: transform .15s ease;
        }

        .cart-button span {
            background: #FF4500;
            border-radius: 12px;
            padding: 2px 6px;
            font-size: 0.9rem;
            margin-left: 4px;
        }
    </style>

</head>

<body>
    <div class="overlay" id="overlay" onclick="closeAllPopups()"></div>
    <header>
        <button class="btn-nav" onclick="playClick(); goHome()">‚Üê Home</button>
        <button class="btn-nav" onclick="playClick(); goBack()">‚Üê Back</button>
    </header>
    <h1>‡πÄ‡∏°‡∏ô‡∏π‡∏≠‡∏≤‡∏´‡∏≤‡∏£</h1>

    <div class="container">
        <div class="order-summary" id="orderSummary" style="display:none;">
            <h3>‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠</h3>
            <div id="orderInfo" style="text-align:center; margin-bottom:8px; font-weight:600; color:#0047AB;"></div>
            <div id="orderItems"></div>
            <div class="summary-total" id="totalSummary"></div>
            <button onclick="playClick(); closeCart()">‚ûï ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏™‡∏±‡πà‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°</button>
            <button onclick="playClick(); promptDiscountAuth()">üéÅ ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
            <button onclick="playClick(); submitOrder()">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</button>
            <button onclick="playClick(); cancelOrder()">‚ùå ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
            <button onclick="playClick(); removeDiscount()">üßπ ‡∏•‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
        </div>
        <div class="menu-grid" id="menuGrid">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...</div>
    </div>

    <div class="popup" id="discountPopup">
        <h3 style="color:#0047AB; margin-bottom:14px;">üéÅ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</h3>
        <div style="display:flex; justify-content:center; gap:12px; flex-wrap:wrap;">
            <button class="discount-btn" onclick="playClick(); applyDiscount(5)">5%</button>
            <button class="discount-btn" onclick="playClick(); applyDiscount(10)">10%</button>
            <button class="discount-btn" onclick="playClick(); applyDiscount(15)">15%</button>
            <button class="discount-btn" onclick="playClick(); applyDiscount(20)">20%</button>
        </div>
        <button class="discount-clear-btn" onclick="playClick(); removeDiscount()">üßπ ‡∏•‡πâ‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î</button>
    </div>

    <div class="popup" id="authPopup">
        <h3>‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏´‡∏±‡∏™‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</h3>
        <input id="pinInput" type="password" maxlength="6" readonly>
        <div class="keypad">
            <button onclick="playClick(); appendPin('1')">1</button>
            <button onclick="playClick(); appendPin('2')">2</button>
            <button onclick="playClick(); appendPin('3')">3</button>
            <button onclick="playClick(); appendPin('4')">4</button>
            <button onclick="playClick(); appendPin('5')">5</button>
            <button onclick="playClick(); appendPin('6')">6</button>
            <button onclick="playClick(); appendPin('7')">7</button>
            <button onclick="playClick(); appendPin('8')">8</button>
            <button onclick="playClick(); appendPin('9')">9</button>
            <button onclick="playClick(); clearPin()">C</button>
            <button onclick="playClick(); appendPin('0')">0</button>
            <button onclick="playClick(); submitPin()">‚úÖ</button>
        </div>
    </div>

    <div class="popup" id="cashPopup">
        <h3>‡∏ä‡∏≥‡∏£‡∏∞‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</h3>
        <p>‡∏¢‡∏≠‡∏î‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ä‡∏≥‡∏£‡∏∞: <strong><span id="cashAmount"></span> ‡∏ø</strong></p>
        <input type="text" id="cashInput" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏µ‡πà‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ä‡∏≥‡∏£‡∏∞" readonly /> 

        <div class="keypad">
            <button onclick="playClick(); appendCash('1')">1</button>
            <button onclick="playClick(); appendCash('2')">2</button>
            <button onclick="playClick(); appendCash('3')">3</button>
            <button onclick="playClick(); appendCash('4')">4</button>
            <button onclick="playClick(); appendCash('5')">5</button>
            <button onclick="playClick(); appendCash('6')">6</button>
            <button onclick="playClick(); appendCash('7')">7</button>
            <button onclick="playClick(); appendCash('8')">8</button>
            <button onclick="playClick(); appendCash('9')">9</button>
            <button onclick="playClick(); clearCash()">C</button>
            <button onclick="playClick(); appendCash('0')">0</button>
            <button onclick="playClick(); confirmCash()">‚úÖ</button>
        </div>
        <p id="changeDisplay" style="margin-top:8px;font-weight:600;"></p>
    </div>

    <div class="popup" id="qrPopup">
        <h3>‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <img id="qrImage" src="kshop.jpg" alt="QR Code">
        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ä‡∏≥‡∏£‡∏∞‡∏¢‡∏≠‡∏î <strong><span id="qrAmount"></span> ‡∏ø</strong></p>
        <button onclick="playClick(); confirmQR()">‚úÖ ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏™‡∏£‡πá‡∏à‡πÅ‡∏•‡πâ‡∏ß</button>
    </div>

    <div class="popup" id="paymentPopup">
        <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô</h3>
        <div class="payment-buttons">
            <button onclick="playClick(); payCash()">üíµ ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î</button>
            <button onclick="playClick(); payQR()">üì± QR Code</button>
        </div>
    </div>

    <div class="popup" id="receiptPopup" style="width:360px;text-align:left;">
        <div class="receipt-header">
            <img src="logo.jpg" alt="‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏£‡πâ‡∏≤‡∏ô‡∏ä‡∏≤‡∏¢‡∏™‡∏µ‡πà‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß">
            <h3 style="text-align:center;">‡∏ä‡∏≤‡∏¢‡∏™‡∏µ‡πà‡∏ö‡∏∞‡∏´‡∏°‡∏µ‡πà‡πÄ‡∏Å‡∏µ‡πä‡∏¢‡∏ß ‡∏Å‡∏≠‡∏•‡πå‡∏ü‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà</h3>
            <h5 style="text-align:center;">‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà 95/7 ‡∏°.7 ‡∏ï.‡πÉ‡∏ô‡πÄ‡∏°‡∏∑‡∏≠‡∏á ‡∏≠.‡∏ö‡πâ‡∏≤‡∏ô‡πÑ‡∏ú‡πà ‡∏à.‡∏Ç‡∏≠‡∏ô‡πÅ‡∏Å‡πà‡∏ô 40110</h5>
            <h5 style="text-align:center;">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ú‡∏π‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏†‡∏≤‡∏©‡∏µ:1409700103387</h5>
            <h5 style="text-align:center;">‡πÇ‡∏ó‡∏£.082-3804188</h5>
        </div>
        <h4 style="text-align:center;">‡πÉ‡∏ö‡∏Å‡∏≥‡∏Å‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏µ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏¢‡πà‡∏≠/üßæ ‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏£‡∏±‡∏ö‡πÄ‡∏á‡∏¥‡∏ô</h4>
        <div id="receiptDetails"></div>
        <h5 style="text-align:center;">‡∏Ç‡∏≠‡∏Ç‡∏≠‡∏ö‡∏û‡∏£‡∏∞‡∏Ñ‡∏∏‡∏ì‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏ó‡∏µ‡πà‡∏°‡∏≤‡∏≠‡∏∏‡∏î‡∏´‡∏ô‡∏∏‡∏ô</h5>
        <button onclick="playClick(); window.print()">üñ®Ô∏è ‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à</button>
        <button onclick="playClick(); closeReceipt()">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÅ‡∏£‡∏Å</button>
    </div>

    <div id="cartButton" class="cart-button" onclick="showCart()">
        üõí <span id="cartCount">0</span>
    </div>

    <script>
        // üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÅ‡∏•‡∏∞‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏±‡∏ô‡πÉ‡∏ô Global Scope
        let order = {};
        let discountPercent = 0;
        let menuMap = {}; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏Å‡πá‡∏ö ID ‡πÄ‡∏°‡∏ô‡∏π‡∏à‡∏≤‡∏Å Supabase

        // ------------------ Navigation / Sound ----------------
        // üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏ô‡∏≥‡∏ó‡∏≤‡∏á‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏¢‡∏π‡πà Global Scope
        function goHome() { window.location.href = 'index.html'; }
        function goBack() { window.history.back(); }

        let audioCtx;
        function initAudio() {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        function playClick() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = "square";
            osc.frequency.value = 550;
            gain.gain.value = 0.08;
            osc.start();
            osc.stop(audioCtx.currentTime + 0.1);
            if (navigator.vibrate) navigator.vibrate(40);
        }
        function playError() {
            initAudio();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.type = "sawtooth";
            osc.frequency.value = 180;
            gain.gain.value = 0.12;
            osc.start();
            osc.stop(audioCtx.currentTime + 0.25);
            if (navigator.vibrate) navigator.vibrate([100, 60, 100]);
        }
        const _alert = window.alert; // ‡πÄ‡∏Å‡πá‡∏ö alert ‡πÄ‡∏î‡∏¥‡∏°
        window.alert = function (msg) {
            playError();
            _alert(msg);
        };
        document.addEventListener("click", () => {
            try {
                if (typeof audioCtx !== "undefined" && audioCtx.state === "suspended") {
                    audioCtx.resume();
                } else if (typeof initAudio === "function" && (!audioCtx || audioCtx.state !== "running")) {
                    initAudio();
                }
            } catch (e) { }
        }, { once: true });
        document.addEventListener("DOMContentLoaded", loadOrderInfo);

        // ------------------ Popup Control ----------------
        function showPopup(id) {
            document.getElementById('overlay').style.display = 'block';
            document.getElementById(id).style.display = 'block';
        }
        function closeAllPopups() {
            document.querySelectorAll('.popup').forEach(p => p.style.display = 'none');
            document.getElementById('overlay').style.display = 'none';
        }
        function closeCart() {
            document.getElementById('orderSummary').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
        }
        function closeReceipt() { closeAllPopups(); }

        // ------------------ Cart/Order Helpers ----------------
        function loadOrderInfo() {
            const orderType = localStorage.getItem("orderType") || "-";
            const customerCount = localStorage.getItem("customerCount") || "-";
            const tableNumber = localStorage.getItem("tableNumber") || "-";
            const text = `üçΩÔ∏è ${orderType} | üë• ${customerCount} ‡∏Ñ‡∏ô | ü™ë ‡πÇ‡∏ï‡πä‡∏∞ ${tableNumber}`;
            const el = document.getElementById("orderInfo");
            if (el) el.innerHTML = text;
        }

        function updateCartCount() {
            const count = Object.values(order).reduce((sum, item) => sum + item.quantity, 0);
            document.getElementById('cartCount').innerText = count;
            document.getElementById('cartButton').style.display = count > 0 ? 'flex' : 'none';
        }

        // ------------------ Order/Cart Logic ----------------
        window.addToOrder = function(item) {
            const n = item.name, p = Number(item.price);
            if (!order[n]) order[n] = { price: p, quantity: 1 };
            else order[n].quantity++;
            updateSummary();
            updateCartCount();
        }
        window.changeQty = function(n, c) {
            if (order[n]) {
                order[n].quantity += c;
                if (order[n].quantity <= 0) delete order[n];
                updateSummary();
                updateCartCount();
            }
        }
        window.removeItem = function(n) {
            delete order[n];
            updateSummary();
            updateCartCount();
        }

        // ------------------ Summary/Discount/Payment Flow ----------------
        function calcTaxFromIncluded(totalWithVat) {
            const beforeVat = totalWithVat / 1.07;
            const vatAmount = totalWithVat - beforeVat;
            return { beforeVat, vatAmount };
        }

        function updateSummary() {
            const items = document.getElementById('orderItems'),
                t = document.getElementById('totalSummary');

            items.innerHTML = '';
            let subtotal = 0;
            for (const n in order) {
                const it = order[n];
                subtotal += it.price * it.quantity;
                // ‡πÉ‡∏ä‡πâ window.changeQty ‡πÅ‡∏•‡∏∞ window.removeItem ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Global ‡πÑ‡∏î‡πâ
                items.innerHTML += `
            <div class='order-item'>
                <div>${n}</div>
                <div class='controls'>
                    <button onclick="window.changeQty('${n}',-1)">-</button>
                    <span>${it.quantity}</span>
                    <button onclick="window.changeQty('${n}',1)">+</button>
                    <button onclick="window.removeItem('${n}')">üóëÔ∏è</button>
                </div>
            </div>`;
            }

            const discount = subtotal * (discountPercent / 100);
            const totalAfterDiscount = subtotal - discount;
            const { beforeVat, vatAmount } = calcTaxFromIncluded(totalAfterDiscount);
            const net = totalAfterDiscount;

            t.innerHTML = `
            ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ): ${subtotal.toFixed(2)} ‡∏ø<br>
            ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${discountPercent}%): ${discount.toFixed(2)} ‡∏ø<br>
            ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ: ${beforeVat.toFixed(2)} ‡∏ø<br>
            ‡∏†‡∏≤‡∏©‡∏µ (7%): ${vatAmount.toFixed(2)} ‡∏ø<br>
            <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥ (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ): ${net.toFixed(2)} ‡∏ø</strong>
            `;
        }

        function getTotal() {
            let subtotal = Object.values(order).reduce((s, i) => s + i.price * i.quantity, 0);
            const discount = subtotal * (discountPercent / 100);
            return subtotal - discount;
        }

        window.submitOrder = function() {
            if (Object.keys(order).length === 0) {
                alert('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠');
                return;
            }
            showPopup('paymentPopup');
        }

        window.cancelOrder = function() {
            if (confirm('‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠?')) {
                order = {};
                discountPercent = 0;
                updateSummary();
                updateCartCount();
                closeAllPopups();
            }
        }

        window.promptDiscountAuth = function() { showPopup('authPopup'); }
        window.submitPin = function() {
            const pin = document.getElementById('pinInput').value;
            if (pin === '000000') {
                closeAllPopups();
                showPopup('discountPopup');
                window.clearPin();
            } else {
                alert('‡∏£‡∏´‡∏±‡∏™‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                window.clearPin();
            }
        }
        window.applyDiscount = function(p) {
            discountPercent = p;
            closeAllPopups();
            updateSummary();
            updateCartCount();
        }
        window.removeDiscount = function() {
            discountPercent = 0;
            closeAllPopups();
            updateSummary();
            updateCartCount();
        }
        window.appendPin = function(num) {
            const input = document.getElementById('pinInput');
            if (input.value.length < 6) input.value += num;
        }
        window.clearPin = function() {
            document.getElementById('pinInput').value = '';
        }

        window.payCash = function() {
            closeAllPopups();
            const t = getTotal();
            document.getElementById('cashAmount').innerText = t.toFixed(2);
            showPopup('cashPopup');
            clearCash();
        }

        window.payQR = function() {
            closeAllPopups();
            const t = getTotal();
            document.getElementById('qrAmount').innerText = t.toFixed(2);
            showPopup('qrPopup');
        }
        // üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Keypad ‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î
        window.appendCash = function(num) {
            const input = document.getElementById('cashInput');
            input.value += num;
        }
        window.clearCash = function() {
            document.getElementById('cashInput').value = '';
            document.getElementById('changeDisplay').innerText = '';
        }

        window.confirmCash = async function() {
            const paid = Number(document.getElementById('cashInput').value || 0);
            const t = getTotal();
            if (paid < t) return alert("‡πÄ‡∏á‡∏¥‡∏ô‡πÑ‡∏°‡πà‡∏û‡∏≠ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á");
            const change = paid - t;

            try {
                // await saveOrderToSupabase('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î');
                document.getElementById('changeDisplay').innerText = `‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change.toFixed(2)} ‡∏ø`;
                setTimeout(() => showReceipt('‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', paid, change), 800);
            } catch (err) {
                console.error("Supabase INSERT Error:", err);
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Policy");
            }
        }

        window.confirmQR = async function() {
            try {
                // await saveOrderToSupabase('QR Code');
                showReceipt('QR Code', getTotal(), 0);
            } catch (err) {
                console.error("Supabase INSERT Error:", err);
                alert("‚ùå ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Policy");
            }
        }
        
        // ------------------ Receipt ----------------
        function showReceipt(method, paid, change) {
            const orderType = localStorage.getItem("orderType") || "-";
            const customerCount = localStorage.getItem("customerCount") || "-";
            const tableNumber = localStorage.getItem("tableNumber") || "-";
            closeAllPopups();

            let html = `
            <div style="margin-bottom:10px; font-weight:600;">
                üçΩÔ∏è ${orderType} | üë• ${customerCount} ‡∏Ñ‡∏ô | ü™ë ‡πÇ‡∏ï‡πä‡∏∞ ${tableNumber}
            </div>
            <table class="receipt-table">
                <tr>
                    <th style="width:60%; text-align:left;">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th>
                    <th style="width:20%; text-align:center;">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
                    <th style="width:20%; text-align:right;">‡∏£‡∏≤‡∏Ñ‡∏≤</th>
                </tr>`;

            let subtotal = 0, totalQty = 0;
            for (const n in order) {
                const it = order[n];
                subtotal += it.price * it.quantity;
                totalQty += it.quantity;
                html += `
                <tr>
                    <td>${n}</td>
                    <td style="text-align:center;">${it.quantity}</td>
                    <td style="text-align:right;">${(it.price * it.quantity).toFixed(2)}</td>
                </tr>`;
            }

            const discount = subtotal * (discountPercent / 100);
            const totalAfterDiscount = subtotal - discount;
            const { beforeVat, vatAmount } = calcTaxFromIncluded(totalAfterDiscount);
            const net = totalAfterDiscount;

            html += `
            <tr>
                <td colspan="3" style="text-align:left; font-weight:bold;">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ${totalQty} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</td>
            </tr>
            </table>

            <div style="display:flex; justify-content:space-between; margin-top:10px; border-top: 1px dashed rgba(0,0,0,0.15); padding-top: 10px;">
                <div style="text-align:left; font-size:0.9rem;">
                    ‡∏ß‡∏¥‡∏ò‡∏µ‡∏ä‡∏≥‡∏£‡∏∞: ${method}<br>
                    ${method === '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î' ? `‡∏ä‡∏≥‡∏£‡∏∞‡∏°‡∏≤: ${paid.toFixed(2)} ‡∏ø<br>‡πÄ‡∏á‡∏¥‡∏ô‡∏ó‡∏≠‡∏ô: ${change.toFixed(2)} ‡∏ø<br>` : ''}
                    ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleString('th-TH')}
                </div>
                <div style="text-align:right; font-size:0.9rem;">
                    ‡∏¢‡∏≠‡∏î‡∏£‡∏ß‡∏° (‡∏£‡∏ß‡∏°‡∏†‡∏≤‡∏©‡∏µ): ${subtotal.toFixed(2)} ‡∏ø<br>
                    ‡∏™‡πà‡∏ß‡∏ô‡∏•‡∏î (${discountPercent}%): ${discount.toFixed(2)} ‡∏ø<br>
                    ‡∏£‡∏≤‡∏Ñ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡∏†‡∏≤‡∏©‡∏µ: ${beforeVat.toFixed(2)} ‡∏ø<br>
                    ‡∏†‡∏≤‡∏©‡∏µ (7%): ${vatAmount.toFixed(2)} ‡∏ø<br>
                    <strong>‡∏£‡∏≤‡∏Ñ‡∏≤‡∏™‡∏∏‡∏ó‡∏ò‡∏¥: ${net.toFixed(2)} ‡∏ø</strong>
                </div>
            </div>`;

            document.getElementById('receiptDetails').innerHTML = html;
            showPopup('receiptPopup');

            // ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡πÉ‡∏ö‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
            order = {};
            discountPercent = 0;
            updateSummary();
            updateCartCount();
        }

        window.showCart = function() {
            if (Object.keys(order).length === 0) return alert("‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤");
            showPopup('orderSummary');
            updateSummary(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Å‡πà‡∏≠‡∏ô‡πÅ‡∏™‡∏î‡∏á
        }

    </script>

    <script type="module">
        import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm";

        // ‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï URL/KEY ‡πÉ‡∏´‡πâ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
        const SUPABASE_URL = "https://pujxykbpxsncbrlquaxo.supabase.co"; 
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso";

        const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
        const menuGrid = document.getElementById("menuGrid");

        async function loadMenu() {
            try {
                menuGrid.innerHTML = "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π...";
                
                const { data, error } = await supabase
                    .from("menu")
                    .select("id,name,price,category,image,available")
                    .eq("available", true)
                    .order("id", { ascending: true });

                if (error) {
                    console.error("Supabase Error:", error.message);
                    throw new Error("Failed to fetch menu data. Check RLS Policy for 'menu' table.");
                }

                if (!data || data.length === 0) {
                    menuGrid.innerHTML = "<p style='text-align:center;'>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÄ‡∏°‡∏ô‡∏π</p>";
                    return;
                }

                menuGrid.innerHTML = data.map(item => {
                    window.menuMap[item.name] = { id: item.id, price: item.price }; 
                    const imageUrl = item.image || 'kshop.jpg'; // ‡πÉ‡∏ä‡πâ URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡∏à‡∏≤‡∏Å Supabase ‡∏´‡∏£‡∏∑‡∏≠‡∏£‡∏π‡∏õ‡∏™‡∏≥‡∏£‡∏≠‡∏á

                    // üõ†Ô∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Global ‡∏î‡πâ‡∏ß‡∏¢ window.addToOrder
                    return `
                        <div class="menu-item" onclick="window.playClick(); window.addToOrder({ name: '${item.name.replace(/'/g, "\\'")}', price: ${item.price} })">
                            <div class="image-placeholder">
                                <img src="${imageUrl}" alt="${item.name}" onerror="this.src='kshop.jpg'">
                            </div>
                            <h3 style="margin:8px 0;font-size:1.1rem;">${item.name}</h3>
                            <strong style="color:#0047AB;font-size:1.1rem;">${item.price} ‡∏ø</strong>
                        </div>
                    `;
                }).join("");
            } catch (err) {
                console.error("Error loading menu:", err);
                menuGrid.innerHTML = `<p style='color:red;text-align:center;'>‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏°‡∏ô‡∏π: ${err.message}</p>`;
            }
        }
        
        loadMenu();

    </script>
</body>
</html>
